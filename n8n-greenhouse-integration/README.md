# üå± n8n Greenhouse Integration –¥–ª—è UgAgro 95

–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è n8n –¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ø–ª–∏—Ü–µ–π ESP32 UgAgro_95_refactored.

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–û–±–∑–æ—Ä](#–æ–±–∑–æ—Ä)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞)
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞](#–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
- [Workflows](#workflows)
- [–í–µ–±-–¥–∞—à–±–æ—Ä–¥](#–≤–µ–±-–¥–∞—à–±–æ—Ä–¥)
- [Telegram –ë–æ—Ç](#telegram-–±–æ—Ç)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∞–Ω–Ω—ã—Ö](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–¥–∞–Ω–Ω—ã—Ö)
- [–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ù–µ–ø–æ–ª–∞–¥–æ–∫](#—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–Ω–µ–ø–æ–ª–∞–¥–æ–∫)

---

## üéØ –û–±–∑–æ—Ä

–≠—Ç–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:

- ‚úÖ **MQTT Data Pipeline** - –ø—Ä–∏–µ–º –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç ESP32
- ‚úÖ **Critical Alerts Monitor** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è–º–∏
- ‚úÖ **Telegram Bot** - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
- ‚úÖ **Web Dashboard** - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ **Data Rotation** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
ESP32 (UgAgro_95)
    ‚Üì MQTT
MQTT Broker (broker.emqx.io)
    ‚Üì
n8n Workflow #1: MQTT Data Pipeline
    ‚Üì
JSON Database (/data/ugagro_readings.json)
    ‚Üì
n8n Workflow #2: Critical Alerts Monitor (–∫–∞–∂–¥—ã–µ 20 —Å–µ–∫)
    ‚Üì
Telegram Bot (–ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö)
    ‚Üì
n8n Workflow #3: Telegram Callback Handler
```

---

## üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **n8n** v1.0+ (self-hosted –∏–ª–∏ cloud)
- **Node.js** v18+ (–¥–ª—è n8n)
- **MQTT Broker** (broker.emqx.io –∏–ª–∏ —Å–≤–æ–π)
- **Telegram Bot** (—Å–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ @BotFather)
- **–í–µ–±-—Å–µ—Ä–≤–µ—Ä** (Nginx/Apache –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞)

### ESP32

- –ü—Ä–æ–µ–∫—Ç UgAgro_95_refactored –∑–∞–ø—É—â–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ MQTT
- MQTT —Ç–æ–ø–∏–∫: `greenhouse/esp32/all_sensors`

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ n8n

#### Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
docker run -d \
  --name n8n \
  -p 5678:5678 \
  -e GENERIC_TIMEZONE="Europe/Moscow" \
  -e TZ="Europe/Moscow" \
  -v ~/.n8n:/home/node/.n8n \
  n8nio/n8n
```

#### npm

```bash
npm install -g n8n
n8n start
```

### –®–∞–≥ 2: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/Daydyaefim/Balagan.git
cd Balagan/n8n-greenhouse-integration
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–∞–Ω–Ω—ã—Ö

```bash
mkdir -p /data
chmod 777 /data
```

### –®–∞–≥ 4: –ò–º–ø–æ—Ä—Ç workflows –≤ n8n

1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n UI: `http://localhost:5678`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Workflows** ‚Üí **Import from File**
3. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –ø–æ –æ—á–µ—Ä–µ–¥–∏:
   - `workflows/01-mqtt-data-pipeline.json`
   - `workflows/02-critical-alerts-monitor.json`
   - `workflows/03-telegram-callback-handler.json`
   - `workflows/04-web-dashboard-api.json`
   - `workflows/05-data-rotation-cleanup.json`

### –®–∞–≥ 5: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤–µ–±-–¥–∞—à–±–æ—Ä–¥–∞

#### Nginx

```bash
# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –¥–∞—à–±–æ—Ä–¥–∞
sudo cp -r web-dashboard /var/www/greenhouse-dashboard

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx
sudo nano /etc/nginx/sites-available/greenhouse
```

```nginx
server {
    listen 80;
    server_name your-domain.com;

    root /var/www/greenhouse-dashboard;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    # –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ API –∫ n8n
    location /webhook/ {
        proxy_pass http://localhost:5678/webhook/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
sudo ln -s /etc/nginx/sites-available/greenhouse /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ Telegram –ë–æ—Ç–∞

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –∏ –Ω–∞–ø–∏—à–∏—Ç–µ @BotFather
/newbot
# –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
# –ü–æ–ª—É—á–∏—Ç–µ TOKEN

# –ü–æ–ª—É—á–∏—Ç–µ CHAT_ID
# –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É @userinfobot –∫–æ–º–∞–Ω–¥—É /start
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ credentials –≤ n8n

#### MQTT Broker

1. **Settings** ‚Üí **Credentials** ‚Üí **New**
2. –¢–∏–ø: **MQTT**
3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - **Protocol**: `mqtt`
   - **Host**: `broker.emqx.io`
   - **Port**: `1883`
   - **Username**: (–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)
   - **Password**: (–æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º)

#### Telegram Bot

1. **Settings** ‚Üí **Credentials** ‚Üí **New**
2. –¢–∏–ø: **Telegram API**
3. –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - **Access Token**: `–≤–∞—à_—Ç–æ–∫–µ–Ω_–æ—Ç_BotFather`

### 3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### Docker

```bash
docker run -d \
  --name n8n \
  -p 5678:5678 \
  -e TELEGRAM_BOT_TOKEN="–≤–∞—à_—Ç–æ–∫–µ–Ω" \
  -e TELEGRAM_CHAT_ID="–≤–∞—à_chat_id" \
  -v ~/.n8n:/home/node/.n8n \
  -v /data:/data \
  n8nio/n8n
```

#### .env —Ñ–∞–π–ª (–¥–ª—è npm)

```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env
nano ~/.n8n/.env
```

```env
TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω
TELEGRAM_CHAT_ID=–≤–∞—à_chat_id
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å
```

### 4. –ê–∫—Ç–∏–≤–∞—Ü–∏—è workflows

–í n8n UI:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–∂–¥—ã–π workflow
2. –ù–∞–∂–º–∏—Ç–µ **Active** (–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É)
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ –Ω–æ–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîÑ Workflows

### Workflow 1: MQTT Data Pipeline

**–¢—Ä–∏–≥–≥–µ—Ä**: MQTT —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —Ç–æ–ø–∏–∫ `greenhouse/esp32/all_sensors`

**–§—É–Ω–∫—Ü–∏–∏**:
- –ü–∞—Ä—Å–∏–Ω–≥ JSON payload
- –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ JSON –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- –†–æ—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (7 –¥–Ω–µ–π)

### Workflow 2: Critical Alerts Monitor

**–¢—Ä–∏–≥–≥–µ—Ä**: –ö–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Ä–æ–≥–∏**:
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: < 10¬∞C –∏–ª–∏ > 40¬∞C
- –í–ª–∞–∂–Ω–æ—Å—Ç—å: < 20% –∏–ª–∏ > 85%
- –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã: < 5%
- –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞: > 11 –º/—Å

**–§—É–Ω–∫—Ü–∏–∏**:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–æ—Ä–æ–≥–∞–º–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ Telegram –æ–ø–æ–≤–µ—â–µ–Ω–∏–π —Å –∫–Ω–æ–ø–∫–æ–π "–ü—Ä–∏–Ω—è—Ç–æ –∫ —Å–≤–µ–¥–µ–Ω–∏—é"
- State management (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ø–∞–º–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)

### Workflow 3: Telegram Callback Handler

**–¢—Ä–∏–≥–≥–µ—Ä**: Callback –æ—Ç Telegram (–Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏)

**–§—É–Ω–∫—Ü–∏–∏**:
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è "‚úÖ –ü—Ä–∏–Ω—è—Ç–æ –∫ —Å–≤–µ–¥–µ–Ω–∏—é"
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è acknowledged
- –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –æ—Ç–º–µ—Ç–∫–æ–π –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏

### Workflow 4: Web Dashboard API

**–¢—Ä–∏–≥–≥–µ—Ä**: Webhook GET `/webhook/api/readings?hours=24`

**–§—É–Ω–∫—Ü–∏–∏**:
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–∏
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
- –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (min, max, avg)
- –í–æ–∑–≤—Ä–∞—Ç JSON –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞

### Workflow 5: Data Rotation & Cleanup

**–¢—Ä–∏–≥–≥–µ—Ä**: Cron (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 02:00)

**–§—É–Ω–∫—Ü–∏–∏**:
- –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏–π —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
- –£–¥–∞–ª–µ–Ω–∏–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
- –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–∞ –æ—á–∏—Å—Ç–∫–∏
- Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö

---

## üìä –í–µ–±-–¥–∞—à–±–æ—Ä–¥

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

- **–ö–∞—Ä—Ç–æ—á–∫–∏ —Å–µ–Ω—Å–æ—Ä–æ–≤** —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π:
  - –ó–µ–ª–µ–Ω—ã–π: –Ω–æ—Ä–º–∞
  - –ñ–µ–ª—Ç—ã–π: –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
  - –ö—Ä–∞—Å–Ω—ã–π: –∫—Ä–∏—Ç–∏—á–Ω–æ

- **–ì—Ä–∞—Ñ–∏–∫–∏ Chart.js** (24 —á–∞—Å–∞):
  - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (—Ç–µ–ø–ª–∏—Ü–∞ + —É–ª–∏—Ü–∞)
  - –í–ª–∞–∂–Ω–æ—Å—Ç—å (—Ç–µ–ø–ª–∏—Ü–∞ + —É–ª–∏—Ü–∞)
  - –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã
  - –°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞

- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**:
  - –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ä–∞—Å—Ç–≤–æ—Ä–∞
  - –ü–∏—Ä–∞–Ω–æ–º–µ—Ç—Ä (—Å–æ–ª–Ω–µ—á–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è)
  - –ü–æ–∑–∏—Ü–∏—è –æ–∫–Ω–∞
  - –°–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä, –æ–±–æ–≥—Ä–µ–≤, –Ω–∞—Å–æ—Å)

- **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

### –î–æ—Å—Ç—É–ø

```
http://your-domain.com
```

---

## ü§ñ Telegram –ë–æ—Ç

### –ö–æ–º–∞–Ω–¥—ã

*(–î–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–π—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π workflow)*

- `/status` - —Ç–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è
- `/export` - —ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —Å—É—Ç–∫–∏ –≤ CSV
- `/reset_alerts` - —Å–±—Ä–æ—Å –≤—Å–µ—Ö –æ–ø–æ–≤–µ—â–µ–Ω–∏–π

### –ü—Ä–∏–º–µ—Ä –æ–ø–æ–≤–µ—â–µ–Ω–∏—è

```
‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê

üå°Ô∏è –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 8.5¬∞C
üìä –ù–æ—Ä–º–∞: 10-40¬∞C
‚è∞ –í—Ä–µ–º—è: 2025-01-18T12:34:56Z

[‚úÖ –ü—Ä–∏–Ω—è—Ç–æ –∫ —Å–≤–µ–¥–µ–Ω–∏—é]
```

–ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏:
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –æ—Ç–º–µ—Ç–∫–æ–π –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏
- –û–ø–æ–≤–µ—â–µ–Ω–∏—è –ø–æ —ç—Ç–æ–º—É –ø–∞—Ä–∞–º–µ—Ç—Ä—É –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è
- –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –Ω–æ—Ä–º—É acknowledged –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∞–Ω–Ω—ã—Ö

### MQTT Payload (`greenhouse/esp32/all_sensors`)

```json
{
  "timestamp": 1705584896,
  "timestamp_iso": "2025-01-18T12:34:56Z",
  "temperature": 24.5,
  "humidity": 65.2,
  "water_level": 78.0,
  "wind_speed": 3.2,
  "pyrano": 450.5,
  "solution_temperature": 21.3,
  "outdoor_temperature": 15.8,
  "outdoor_humidity": 72.1,
  "mat_temperature": 22.1,
  "mat_hum": 68.5,
  "mat_ec": 1.8,
  "mat_ph": 6.2,
  "window_position": 45,
  "fan_state": true,
  "heat_state": false,
  "pump_state": true,
  "fog_state": false,
  "sol_heat_state": false,
  "hydro_mix": false,
  "fill_state": false,
  "watering_mode": 2,
  "rad_sum": 1234.5,
  "cycle_count": 3,
  "last_watering_start_unix": 1705580000,
  "force_watering_active": false,
  "force_watering_override": false,
  "force_watering_end_time_unix": 0
}
```

### JSON Database (`/data/ugagro_readings.json`)

```json
[
  {
    "timestamp": 1705584896,
    "timestamp_iso": "2025-01-18T12:34:56Z",
    "temperature": 24.5,
    ...
  },
  ...
]
```

### Alert States (`/data/telegram_alert_states.json`)

```json
{
  "temperature": {
    "acknowledged": true,
    "lastAlert": "2025-01-18T12:00:00Z",
    "acknowledgedBy": "Ivan"
  },
  "humidity": {
    "acknowledged": false,
    "lastAlert": null
  },
  "water_level": {
    "acknowledged": false,
    "lastAlert": null
  },
  "wind_speed": {
    "acknowledged": false,
    "lastAlert": null
  }
}
```

---

## üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ù–µ–ø–æ–ª–∞–¥–æ–∫

### n8n –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç MQTT –¥–∞–Ω–Ω—ã–µ

**–ü—Ä–æ–±–ª–µ–º–∞**: Workflow –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MQTT –±—Ä–æ–∫–µ—Ä—É: `mqtt.fx` –∏–ª–∏ `mosquitto_sub`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ESP32 –ø—É–±–ª–∏–∫—É–µ—Ç –¥–∞–Ω–Ω—ã–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ credentials –≤ n8n
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ n8n: `docker logs n8n`

### Telegram –±–æ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞**: –û–ø–æ–≤–µ—â–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CHAT_ID
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞–ø–∏—Å–∞–ª–∏ –±–æ—Ç—É `/start`
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ workflow #2 –∞–∫—Ç–∏–≤–µ–Ω

### –í–µ–±-–¥–∞—à–±–æ—Ä–¥ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: –ü—É—Å—Ç–æ–π —ç–∫—Ä–∞–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ 404

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª–∞–º
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ workflow #4 –∞–∫—Ç–∏–≤–µ–Ω –∏ webhook —Ä–∞–±–æ—Ç–∞–µ—Ç

### –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: `/data/ugagro_readings.json` –ø—É—Å—Ç

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: `chmod 777 /data`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ Docker volume
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ workflow #1

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –§—É–Ω–∫—Ü–∏–∏

### –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV

–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π workflow:

```javascript
// Node: Function
const readings = JSON.parse($node["–ß–∏—Ç–∞—Ç—å –ë–î"].json.data);
const csv = readings.map(r =>
  `${r.timestamp_iso},${r.temperature},${r.humidity},${r.water_level},${r.wind_speed}`
).join('\n');

return [{ json: { csv }, binary: { data: Buffer.from(csv) } }];
```

### Grafana Integration

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Grafana JSON Data Source –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook API.

---

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ n8n
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö –≤ `/data/`
3. –û—Ç–∫—Ä–æ–π—Ç–µ issue –≤ GitHub

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License

---

## üë®‚Äçüíª –ê–≤—Ç–æ—Ä

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ UgAgro 95 - –∞–≤—Ç–æ–Ω–æ–º–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ–ø–ª–∏—Ü–µ–π –Ω–∞ –±–∞–∑–µ ESP32.

**ESP32 Repository**: https://github.com/Daydyaefim/Balagan

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è

### v1.0.0 (2025-01-18)
- –ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑
- 5 workflows
- –í–µ–±-–¥–∞—à–±–æ—Ä–¥ —Å Chart.js
- Telegram –±–æ—Ç —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
