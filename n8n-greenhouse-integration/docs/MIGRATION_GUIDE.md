# üîÑ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

## –ë—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± (—á–µ—Ä–µ–∑ n8n)

### –®–∞–≥ 1: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å workflow –º–∏–≥—Ä–∞—Ü–∏–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n
2. –ù–∞–∂–º–∏—Ç–µ **"+ Add workflow"** ‚Üí **"Import from file"**
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª: `workflows/database-migrations.json`
4. Workflow –ø–æ—è–≤–∏—Ç—Å—è –≤ –≤–∞—à–µ–º —Å–ø–∏—Å–∫–µ

### –®–∞–≥ 2: –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow **"Database Migrations - Watering & Connection Lost"**
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PostgreSQL credentials –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"Test workflow"** –∏–ª–∏ **"Execute Workflow"**
4. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–í —É–∑–ª–µ **"–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç—ã"** –≤—ã —É–≤–∏–¥–∏—Ç–µ:
- ‚úÖ –°—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
- üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- üéâ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• –ó–ê–í–ï–†–®–ï–ù–ê

üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

  ‚Ä¢ watering_settings: 1 –∑–∞–ø–∏—Å–µ–π
  ‚Ä¢ watering_notifications: 1 –∑–∞–ø–∏—Å–µ–π
  ‚Ä¢ telegram_alert_states (esp32_connection_lost): 1 –∑–∞–ø–∏—Å–µ–π

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üéâ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!

–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ workflow
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TELEGRAM_CHAT_ID –≤ workflow —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ workflow
```

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± (—á–µ—Ä–µ–∑ psql)

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ PostgreSQL:

```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
psql -U your_user -d greenhouse_db -f database/watering-settings-table.sql
psql -U your_user -d greenhouse_db -f database/watering-notifications-table.sql
psql -U your_user -d greenhouse_db -f database/add-connection-lost-alert.sql
```

---

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—è?

### 1. –¢–∞–±–ª–∏—Ü–∞ `watering_settings`
–•—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã –ø–æ–ª–∏–≤–∞:
- –ü–æ—Ä–æ–≥ —Ä–∞–¥–∏–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 500 –í—Ç/–º¬≤)
- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60 —Å–µ–∫)
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–æ–ª–∏–≤–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 180 –º–∏–Ω)
- –û–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 08:00-20:00)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –ø–æ–ª–∏–≤–∞

### 2. –¢–∞–±–ª–∏—Ü–∞ `watering_notifications`
–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ–ª–∏–≤–µ:
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞—Å–æ—Å–∞
- –¢–∏–ø –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª–∏–≤–æ–≤

### 3. –ù–æ–≤—ã–π —Ç–∏–ø –æ–ø–æ–≤–µ—â–µ–Ω–∏—è `esp32_connection_lost`
–î–æ–±–∞–≤–ª—è–µ—Ç –≤ `telegram_alert_states`:
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏ —Å ESP32
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
- –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö >15 –º–∏–Ω—É—Ç

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ PostgreSQL –∏–ª–∏ —á–µ—Ä–µ–∑ n8n:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª–∏–≤–∞
SELECT * FROM watering_settings;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
SELECT * FROM watering_notifications;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
SELECT * FROM telegram_alert_states WHERE alert_type = 'esp32_connection_lost';
```

---

## –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

```sql
-- –£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
DROP TABLE IF EXISTS watering_settings;
DROP TABLE IF EXISTS watering_notifications;

-- –£–¥–∞–ª–∏—Ç—å —Ç–∏–ø –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
DELETE FROM telegram_alert_states WHERE alert_type = 'esp32_connection_lost';
```

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:

1. ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ workflow:
   - `telegram-bot-commands.json` (–æ–±–Ω–æ–≤–ª–µ–Ω)
   - `telegram-critical-alerts.json` (–æ–±–Ω–æ–≤–ª–µ–Ω)
   - `telegram-watering-notifications.json` (–Ω–æ–≤—ã–π)

2. ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
   - –í `telegram-watering-notifications.json` —É–∫–∞–∂–∏—Ç–µ –≤–∞—à `TELEGRAM_CHAT_ID`
   - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `watering_settings`

3. üöÄ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ workflow

4. üì± –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:
   - `/status` - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
   - `/poliv` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–∏–≤–µ

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ UgAgro 95**
