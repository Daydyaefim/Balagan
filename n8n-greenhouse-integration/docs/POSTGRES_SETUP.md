# üöÄ –ü–ï–†–ï–•–û–î –ù–ê POSTGRESQL - –ü–û–õ–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø

## ‚úÖ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê

- ‚ùå –ù–∏–∫–∞–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º —Å –ø—É—Ç—è–º–∏ –∫ —Ñ–∞–π–ª–∞–º
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- ‚úÖ PostgreSQL —É–∂–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤ –≤–∞—à–µ–º Docker

---

## üìã –®–ê–ì 1: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•

### 1.1 –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É

```bash
docker exec -it <–∏–º—è_–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞_postgres> psql -U root -d n8n
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Beget File Manager:
1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å Beget
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Docker** ‚Üí **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã**
3. –ù–∞–π–¥–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `postgres`
4. –ù–∞–∂–º–∏—Ç–µ **Terminal**

### 1.2 –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `database/init-greenhouse-db.sql` –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª PostgreSQL.

–ò–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª:

```bash
# –°–∫–∞—á–∞–π—Ç–µ —Ñ–∞–π–ª init-greenhouse-db.sql —Å GitHub –≤ –ø–∞–ø–∫—É /opt/beget/n8n/
# –ó–∞—Ç–µ–º:
docker exec -i <postgres_container> psql -U root -d n8n < /opt/beget/n8n/init-greenhouse-db.sql
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
CREATE TABLE
CREATE INDEX
...
UgAgro Greenhouse Database initialized!
```

---

## üìã –®–ê–ì 2: –ù–ê–°–¢–†–û–ô–ö–ê CREDENTIALS –í N8N

### 2.1 –°–æ–∑–¥–∞–π—Ç–µ PostgreSQL Credential

1. –í n8n –æ—Ç–∫—Ä–æ–π—Ç–µ **Settings** (‚öôÔ∏è) ‚Üí **Credentials**
2. –ù–∞–∂–º–∏—Ç–µ **+ New Credential**
3. –í—ã–±–µ—Ä–∏—Ç–µ **Postgres**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è:

```
Credential Name: Greenhouse PostgreSQL
Host: postgres
Database: n8n
User: root
Password: zjcsEfnM5hwFNYB
Port: 5432
SSL: OFF
```

5. –ù–∞–∂–º–∏—Ç–µ **Create**
6. **–í–ê–ñ–ù–û:** –ó–∞–ø–æ–º–Ω–∏—Ç–µ ID credential (–æ–±—ã—á–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ URL –∏–ª–∏ –≤ —Å–ø–∏—Å–∫–µ)

---

## üìã –®–ê–ì 3: –ò–ú–ü–û–†–¢ –û–ë–ù–û–í–õ–ï–ù–ù–´–• WORKFLOWS

### 3.1 –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ workflows (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞:
1. –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤—Å–µ workflows (#1-#6)
2. –£–¥–∞–ª–∏—Ç–µ –∏—Ö

### 3.2 –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–µ workflows

–°–∫–∞—á–∞–π—Ç–µ —Å GitHub –ø–∞–ø–∫—É `workflows/` –∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ:

1. **01-mqtt-data-pipeline-postgres.json**
2. **04-web-dashboard-api-postgres.json**
3. **05-data-rotation-cleanup-postgres.json**
4. **06-web-dashboard-simple-postgres.json**

–î–ª—è –∫–∞–∂–¥–æ–≥–æ:
- **Workflows** ‚Üí **+ Add Workflow** ‚Üí **Import from File**
- –í—ã–±–µ—Ä–∏—Ç–µ JSON —Ñ–∞–π–ª
- –ù–∞–∂–º–∏—Ç–µ **Import**

---

## üìã –®–ê–ì 4: –ù–ê–°–¢–†–û–ô–ö–ê CREDENTIALS –í WORKFLOWS

–í **–∫–∞–∂–¥–æ–º** –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º workflow:

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow
2. –ù–∞–π–¥–∏—Ç–µ –Ω–æ–¥—É **—Å –∏–∫–æ–Ω–∫–æ–π PostgreSQL** (–æ–±—ã—á–Ω–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ PostgreSQL", "–ü–æ–ª—É—á–∏—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è" –∏ —Ç.–¥.)
3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–¥—É
4. –í –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞–π–¥–∏—Ç–µ **Credential to connect with**
5. –í—ã–±–µ—Ä–∏—Ç–µ **Greenhouse PostgreSQL** (credential —Å–æ–∑–¥–∞–Ω–Ω—ã–π –≤ –®–∞–≥–µ 2)
6. –ù–∞–∂–º–∏—Ç–µ **Save** –Ω–∞ –Ω–æ–¥–µ
7. –ù–∞–∂–º–∏—Ç–µ **Save** –Ω–∞ workflow

–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –¥–ª—è **–≤—Å–µ—Ö PostgreSQL –Ω–æ–¥ –≤–æ –≤—Å–µ—Ö workflows**.

---

## üìã –®–ê–ì 5: –ù–ê–°–¢–†–û–ô–ö–ê MQTT CREDENTIALS

–í Workflow #1:

1. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–¥—É **MQTT Trigger**
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à existing MQTT credential
3. **Save**

---

## üìã –®–ê–ì 6: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### 6.1 –ü—Ä–æ–≤–µ—Ä–∫–∞ Workflow #1 (MQTT Data Pipeline)

1. –û—Ç–∫—Ä–æ–π—Ç–µ **01 - MQTT Data Pipeline (PostgreSQL)**
2. –ù–∞–∂–º–∏—Ç–µ **Test workflow**
3. –î–æ–∂–¥–∏—Ç–µ—Å—å MQTT —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç ESP32 (–¥–æ 30 —Å–µ–∫—É–Ω–¥)
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∑–µ–ª–µ–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –¥–æ—à–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞**
5. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–¥—É **"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ PostgreSQL"** ‚Üí –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Output

### 6.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ PostgreSQL:

```sql
-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö
SELECT COUNT(*) FROM ugagro_readings;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–ø–∏—Å–µ–π
SELECT timestamp_iso, temperature, humidity, water_level, wind_speed
FROM ugagro_readings
ORDER BY timestamp DESC
LIMIT 5;
```

–î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –¥–∞–Ω–Ω—ã–µ!

### 6.3 –ü—Ä–æ–≤–µ—Ä–∫–∞ Dashboard

1. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ **06 - Web Dashboard Simple (PostgreSQL)**
2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
   ```
   https://ipedekdomus.beget.app/webhook/dashboard
   ```
3. –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –∫—Ä–∞—Å–∏–≤—ã–π dashboard —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏!

---

## üìã –®–ê–ì 7: –ê–ö–¢–ò–í–ê–¶–ò–Ø WORKFLOWS

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **01 - MQTT Data Pipeline (PostgreSQL)** ‚Üí ‚úÖ Active
2. **04 - Web Dashboard API (PostgreSQL)** ‚Üí ‚úÖ Active
3. **05 - Data Rotation & Cleanup (PostgreSQL)** ‚Üí ‚úÖ Active
4. **06 - Web Dashboard Simple (PostgreSQL)** ‚Üí ‚úÖ Active

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê

### –í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏:

‚úÖ ESP32 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ ‚Üí Workflow #1 —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ PostgreSQL
‚úÖ Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ: `https://ipedekdomus.beget.app/webhook/dashboard`
‚úÖ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON: `https://ipedekdomus.beget.app/webhook/api/readings`
‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00

---

## ‚ùì –ß–ê–°–¢–´–ï –ü–†–û–ë–õ–ï–ú–´

### "Connection refused" –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ PostgreSQL

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `Host: postgres` (–Ω–µ `localhost`)

### "Credential not found"

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤ –∫–∞–∂–¥–æ–π PostgreSQL –Ω–æ–¥–µ –≤—ã–±—Ä–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π credential

### –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã: `SELECT * FROM ugagro_readings LIMIT 1;`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Output –Ω–æ–¥—ã "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ PostgreSQL" –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

### Dashboard –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤ –ë–î –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
2. –û—Ç–∫—Ä–æ–π—Ç–µ Workflow #6 –∏ –Ω–∞–∂–º–∏—Ç–µ Test
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ Output –∫–∞–∂–¥–æ–π –Ω–æ–¥—ã

---

## üìä –°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó –î–ê–ù–ù–´–•

### –¢–∞–±–ª–∏—Ü—ã:

1. **ugagro_readings** - –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤ (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: 7 –¥–Ω–µ–π)
2. **telegram_alert_states** - —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
3. **ugagro_alerts_history** - –∏—Å—Ç–æ—Ä–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞: 30 –¥–Ω–µ–π)

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è Workflow #5 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 02:00:
```sql
SELECT cleanup_old_data();
```

---

## üîÑ –û–¢–ö–ê–¢ –ù–ê JSON –§–ê–ô–õ–´ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞—Ä—ã–µ workflows:
- `01-mqtt-data-pipeline.json`
- `04-web-dashboard-api.json`
- Etc.

–ù–æ **—Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª—ã** –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏–∑ `FIX_FILE_PATHS.md`

---

## ‚úÖ –í–°–Å –ì–û–¢–û–í–û!

–¢–µ–ø–µ—Ä—å –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ **–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π PostgreSQL –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**!

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å –ø—É—Ç—è–º–∏
- –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞
- –ù–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ
- –õ–µ–≥–∫–æ –¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø—ã
- –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

---

**–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?** –°–æ–∑–¥–∞–π—Ç–µ issue –Ω–∞ GitHub —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã –∏ –ª–æ–≥–∞–º–∏ –∏–∑ n8n.
