# üì° –°—Ç—Ä—É–∫—Ç—É—Ä–∞ MQTT –î–∞–Ω–Ω—ã—Ö - UgAgro 95

## –¢–æ–ø–∏–∫–∏ MQTT

### –ü—É–±–ª–∏–∫—É–µ–º—ã–µ ESP32

| –¢–æ–ø–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ | –§–æ—Ä–º–∞—Ç | –ß–∞—Å—Ç–æ—Ç–∞ |
|-------|----------|--------|---------|
| `greenhouse/esp32/all_sensors` | –í—Å–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤ | JSON | ~30 —Å–µ–∫ |
| `greenhouse/esp32/settings_full` | –ü–æ–ª–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | JSON | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ |
| `greenhouse/esp32/history` | –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫–∞–∑–∞–Ω–∏–π | JSON | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ |
| `greenhouse/esp32/status` | –°—Ç–∞—Ç—É—Å ESP32 | String | –ö–∞–∂–¥—ã–µ 60 —Å–µ–∫ |
| `greenhouse/esp32/window` | –ü–æ–∑–∏—Ü–∏—è –æ–∫–Ω–∞ | Integer | –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ |

### –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è ESP32

| –¢–æ–ø–∏–∫ | –û–ø–∏—Å–∞–Ω–∏–µ | –§–æ—Ä–º–∞—Ç |
|-------|----------|--------|
| `greenhouse/set_settings` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ | JSON |
| `greenhouse/cmd/equipment` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º | JSON |
| `greenhouse/cmd/window` | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–∫–Ω–æ–º | JSON |

---

## üìä –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `greenhouse/esp32/all_sensors`

```json
{
  // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
  "timestamp": 1705584896,              // Unix timestamp (—Å–µ–∫—É–Ω–¥—ã)
  "timestamp_iso": "2025-01-18T12:34:56Z",  // ISO 8601 (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è n8n)
  "received_at": "2025-01-18T12:34:57Z",    // –í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è n8n)

  // === –î–ê–¢–ß–ò–ö–ò –ö–õ–ò–ú–ê–¢–ê ===

  // –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∏ –≤–ª–∞–∂–Ω–æ—Å—Ç—å (—É—Å—Ä–µ–¥–Ω–µ–Ω–Ω–∞—è –≤ —Ç–µ–ø–ª–∏—Ü–µ)
  "temperature": 24.5,                  // ¬∞C, float
  "humidity": 65.2,                     // %, float

  // –£–ª–∏—á–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏
  "outdoor_temperature": 15.8,          // ¬∞C, float
  "outdoor_humidity": 72.1,             // %, float

  // === –î–ê–¢–ß–ò–ö–ò –í–û–î–´ –ò –†–ê–°–¢–í–û–†–ê ===

  "water_level": 78.0,                  // %, float (0-100)
  "solution_temperature": 21.3,         // ¬∞C, float

  // === –î–ê–¢–ß–ò–ö–ò –°–£–ë–°–¢–†–ê–¢–ê (–ú–ê–¢) ===

  "mat_temperature": 22.1,              // ¬∞C, float
  "mat_hum": 68.5,                      // %, float
  "mat_ec": 1.8,                        // EC (—ç–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç—å), float
  "mat_ph": 6.2,                        // pH, float

  // === –ú–ï–¢–ï–û –î–ê–¢–ß–ò–ö–ò ===

  "wind_speed": 3.2,                    // –º/—Å, float
  "pyrano": 450.5,                      // –í—Ç/–º¬≤ (—Å–æ–ª–Ω–µ—á–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è), float

  // === –ê–ö–¢–£–ê–¢–û–†–´ –ò –°–û–°–¢–û–Ø–ù–ò–Ø ===

  "window_position": 45,                // %, integer (0-100)
  "fan_state": true,                    // boolean
  "heat_state": false,                  // boolean
  "pump_state": true,                   // boolean
  "fog_state": false,                   // boolean
  "sol_heat_state": false,              // boolean (–ø–æ–¥–æ–≥—Ä–µ–≤ —Ä–∞—Å—Ç–≤–æ—Ä–∞)
  "hydro_mix": false,                   // boolean (–º–∏–∫—Å–µ—Ä –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∏)
  "fill_state": false,                  // boolean (–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤—É–∞—Ä–∞)

  // === –ü–û–õ–ò–í –ò –£–ü–†–ê–í–õ–ï–ù–ò–ï ===

  "watering_mode": 2,                   // integer (0-3)
                                        // 0: manual, 1: morning, 2: radiation, 3: forced
  "rad_sum": 1234.5,                    // float (—Å—É–º–º–∞ —Ä–∞–¥–∏–∞—Ü–∏–∏)
  "cycle_count": 3,                     // integer (—Ü–∏–∫–ª–æ–≤ –ø–æ–ª–∏–≤–∞ —Å–µ–≥–æ–¥–Ω—è)
  "last_watering_start_unix": 1705580000, // Unix timestamp

  // === –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –ü–û–õ–ò–í ===

  "force_watering_active": false,       // boolean
  "force_watering_override": false,     // boolean
  "force_watering_end_time_unix": 0     // Unix timestamp
}
```

---

## üî¢ –î–∏–∞–ø–∞–∑–æ–Ω—ã –∑–Ω–∞—á–µ–Ω–∏–π

### –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ú–∏–Ω | –ù–æ—Ä–º–∞ | –ú–∞–∫—Å | –ö—Ä–∏—Ç–∏—á–Ω–æ |
|----------|-----|-------|------|----------|
| `temperature` | -10¬∞C | 18-28¬∞C | 45¬∞C | <10¬∞C, >40¬∞C |
| `outdoor_temperature` | -40¬∞C | - | 50¬∞C | - |
| `solution_temperature` | 5¬∞C | 18-24¬∞C | 35¬∞C | - |
| `mat_temperature` | 5¬∞C | 18-26¬∞C | 35¬∞C | - |

### –í–ª–∞–∂–Ω–æ—Å—Ç—å

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ú–∏–Ω | –ù–æ—Ä–º–∞ | –ú–∞–∫—Å | –ö—Ä–∏—Ç–∏—á–Ω–æ |
|----------|-----|-------|------|----------|
| `humidity` | 0% | 50-75% | 100% | <20%, >85% |
| `outdoor_humidity` | 0% | - | 100% | - |
| `mat_hum` | 0% | 60-80% | 100% | - |

### –í–æ–¥–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ú–∏–Ω | –ù–æ—Ä–º–∞ | –ú–∞–∫—Å | –ö—Ä–∏—Ç–∏—á–Ω–æ |
|----------|-----|-------|------|----------|
| `water_level` | 0% | 20-100% | 100% | <5% |

### –ú–µ—Ç–µ–æ

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ú–∏–Ω | –ù–æ—Ä–º–∞ | –ú–∞–∫—Å | –ö—Ä–∏—Ç–∏—á–Ω–æ |
|----------|-----|-------|------|----------|
| `wind_speed` | 0 –º/—Å | 0-5 –º/—Å | 30 –º/—Å | >11 –º/—Å |
| `pyrano` | 0 –í—Ç/–º¬≤ | 200-800 –í—Ç/–º¬≤ | 1200 –í—Ç/–º¬≤ | - |

### –°—É–±—Å—Ç—Ä–∞—Ç

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ú–∏–Ω | –ù–æ—Ä–º–∞ | –ú–∞–∫—Å | –ö—Ä–∏—Ç–∏—á–Ω–æ |
|----------|-----|-------|------|----------|
| `mat_ec` | 0 | 1.5-2.5 | 5.0 | - |
| `mat_ph` | 4.0 | 5.5-6.5 | 8.0 | - |

---

## üéØ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ü–æ—Ä–æ–≥–∏ –¥–ª—è –û–ø–æ–≤–µ—â–µ–Ω–∏–π

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ workflow **02-critical-alerts-monitor.json**:

```javascript
const thresholds = {
  temperature: {
    min: 10,    // ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –º–µ–Ω—å—à–µ
    max: 40     // ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ
  },
  humidity: {
    min: 20,    // ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –º–µ–Ω—å—à–µ
    max: 85     // ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ
  },
  water_level: {
    min: 5      // üíß –ö—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –º–µ–Ω—å—à–µ
  },
  wind_speed: {
    max: 11     // üí® –ö—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –±–æ–ª—å—à–µ
  }
};
```

---

## üîÑ –†–µ–∂–∏–º—ã –ø–æ–ª–∏–≤–∞ (`watering_mode`)

| –ó–Ω–∞—á–µ–Ω–∏–µ | –†–µ–∂–∏–º | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| 0 | Manual | –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º (–ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É/–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏) |
| 1 | Morning | –£—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–ª–∏–≤ (N –ø–æ–ª–∏–≤–æ–≤ —É—Ç—Ä–æ–º) |
| 2 | Radiation | –ü–æ–ª–∏–≤ –ø–æ —Ä–∞–¥–∏–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ radSum > –ø–æ—Ä–æ–≥) |
| 3 | Forced | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–ª–∏–≤ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è) |

---

## üì§ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥ ESP32

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫

–¢–æ–ø–∏–∫: `greenhouse/set_settings`

```json
{
  "minTemp": 22.0,
  "maxTemp": 28.0,
  "minHum": 60.0,
  "maxHum": 80.0,
  "radThreshold": 500.0
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º

–¢–æ–ø–∏–∫: `greenhouse/cmd/equipment`

```json
{
  "equipment": "fan",    // fan, heat, pump, fog, sol_heat, hydro_mix
  "state": true          // true = ON, false = OFF
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–∫–Ω–æ–º

–¢–æ–ø–∏–∫: `greenhouse/cmd/window`

```json
{
  "direction": "open",   // open, close, stop
  "duration": 5000       // –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
}
```

–∏–ª–∏

```json
{
  "direction": "stop"
}
```

---

## üõ†Ô∏è –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ n8n

Workflow #1 –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:

```javascript
const requiredFields = [
  'timestamp',
  'temperature',
  'humidity',
  'water_level',
  'wind_speed'
];

for (const field of requiredFields) {
  if (payload[field] === undefined || payload[field] === null) {
    throw new Error(`–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: ${field}`);
  }
}
```

---

## üìä –§–æ—Ä–º–∞—Ç –¥–ª—è Grafana

–ú–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ Grafana Simple JSON:

```json
[
  {
    "target": "temperature",
    "datapoints": [
      [24.5, 1705584896000],
      [24.7, 1705584926000]
    ]
  },
  {
    "target": "humidity",
    "datapoints": [
      [65.2, 1705584896000],
      [65.5, 1705584926000]
    ]
  }
]
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞ MQTT

### mosquitto_sub

```bash
# –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –≤—Å–µ —Ç–æ–ø–∏–∫–∏
mosquitto_sub -h broker.emqx.io -t "greenhouse/#" -v

# –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–ø–∏–∫
mosquitto_sub -h broker.emqx.io -t "greenhouse/esp32/all_sensors" -v
```

### mosquitto_pub (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

```bash
# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
mosquitto_pub -h broker.emqx.io \
  -t "greenhouse/esp32/all_sensors" \
  -m '{"timestamp":1705584896,"temperature":24.5,"humidity":65.2,"water_level":78,"wind_speed":3.2}'
```

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **Timestamp**: ESP32 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Unix timestamp (—Å–µ–∫—É–Ω–¥—ã —Å 1970-01-01), n8n –¥–æ–±–∞–≤–ª—è–µ—Ç ISO —Ñ–æ—Ä–º–∞—Ç
2. **NaN –∑–Ω–∞—á–µ–Ω–∏—è**: –ï—Å–ª–∏ –¥–∞—Ç—á–∏–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, ESP32 –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `NaN` –∏–ª–∏ `0`
3. **–ß–∞—Å—Ç–æ—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏**: ~30 —Å–µ–∫—É–Ω–¥ (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ ESP32)
4. **Retained messages**: –¢–æ–ø–∏–∫–∏ `status` –∏ `window` –ø—É–±–ª–∏–∫—É—é—Ç—Å—è —Å —Ñ–ª–∞–≥–æ–º retained

---

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ UgAgro 95**
