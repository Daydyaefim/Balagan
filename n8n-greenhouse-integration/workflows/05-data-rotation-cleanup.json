{
  "name": "05 - Data Rotation & Cleanup (PostgreSQL)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 2 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger (02:00)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö\nSELECT cleanup_old_data();\n\n-- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\nSELECT\n  (SELECT COUNT(*) FROM ugagro_readings) as total_readings,\n  (SELECT MIN(timestamp_iso) FROM ugagro_readings) as oldest_reading,\n  (SELECT COUNT(*) FROM ugagro_alerts_history) as total_alerts,\n  (SELECT MIN(created_at) FROM ugagro_alerts_history) as oldest_alert,\n  NOW() as cleanup_timestamp;",
        "options": {}
      },
      "id": "cleanup-database",
      "name": "–û—á–∏—Å—Ç–∫–∞ –ë–î",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [450, 300],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—á–∏—Å—Ç–∫–∏\nconst result = $input.first().json;\n\nconst message = `üßπ –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞\\n\\n` +\n  `üìä –ü–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤: ${result.total_readings}\\n` +\n  `üìÖ –°–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ: ${result.oldest_reading}\\n\\n` +\n  `üö® –ò—Å—Ç–æ—Ä–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π: ${result.total_alerts}\\n` +\n  `üìÖ –°–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ: ${result.oldest_alert}\\n\\n` +\n  `‚è∞ –í—Ä–µ–º—è: ${result.cleanup_timestamp}`;\n\nconsole.log(message);\n\nreturn [{\n  json: {\n    success: true,\n    stats: result,\n    message: message,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "format-result",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    }
  ],
  "connections": {
    "Schedule Trigger (02:00)": {
      "main": [
        [
          {
            "node": "–û—á–∏—Å—Ç–∫–∞ –ë–î",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—á–∏—Å—Ç–∫–∞ –ë–î": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-18T00:00:00.000Z",
  "versionId": "2"
}
