{
  "name": "05 - Data Rotation & Cleanup",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 2 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger (02:00)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "read",
        "filePath": "/data/ugagro_readings.json",
        "options": {}
      },
      "id": "read-readings",
      "name": "–ß–∏—Ç–∞—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "read",
        "filePath": "/data/ugagro_alerts_history.json",
        "options": {}
      },
      "id": "read-alerts",
      "name": "–ß–∏—Ç–∞—Ç—å –ò—Å—Ç–æ—Ä–∏—é –û–ø–æ–≤–µ—â–µ–Ω–∏–π",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [450, 450],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π (—Ö—Ä–∞–Ω–∏—Ç—å 7 –¥–Ω–µ–π)\nconst dbData = $node[\"–ß–∏—Ç–∞—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è\"].json.data;\nlet readings = typeof dbData === 'string' ? JSON.parse(dbData) : dbData;\n\nif (!readings || readings.length === 0) {\n  return [{ json: { readings: [], removed: 0 } }];\n}\n\nconst sevenDaysAgo = Date.now() / 1000 - (7 * 24 * 60 * 60);\nconst originalCount = readings.length;\n\n// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è\nreadings = readings.filter(r => r.timestamp > sevenDaysAgo);\n\nconst removed = originalCount - readings.length;\n\nreturn [{\n  json: {\n    readings,\n    removed,\n    remaining: readings.length,\n    oldestTimestamp: readings[0]?.timestamp_iso || null\n  }\n}];"
      },
      "id": "cleanup-readings",
      "name": "–û—á–∏—Å—Ç–∏—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–ø–æ–≤–µ—â–µ–Ω–∏–π (—Ö—Ä–∞–Ω–∏—Ç—å 30 –¥–Ω–µ–π)\nlet alerts = [];\ntry {\n  const alertsData = $node[\"–ß–∏—Ç–∞—Ç—å –ò—Å—Ç–æ—Ä–∏—é –û–ø–æ–≤–µ—â–µ–Ω–∏–π\"].json.data;\n  if (alertsData) {\n    alerts = typeof alertsData === 'string' ? JSON.parse(alertsData) : alertsData;\n  }\n} catch (e) {\n  alerts = [];\n}\n\nif (!alerts || alerts.length === 0) {\n  return [{ json: { alerts: [], removed: 0 } }];\n}\n\nconst thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);\nconst originalCount = alerts.length;\n\n// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è\nalerts = alerts.filter(a => {\n  const timestamp = new Date(a.alert?.latestReading?.timestamp_iso || a.timestamp);\n  return timestamp.getTime() > thirtyDaysAgo;\n});\n\nconst removed = originalCount - alerts.length;\n\nreturn [{\n  json: {\n    alerts,\n    removed,\n    remaining: alerts.length\n  }\n}];"
      },
      "id": "cleanup-alerts",
      "name": "–û—á–∏—Å—Ç–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 450]
    },
    {
      "parameters": {
        "operation": "write",
        "filePath": "/data/ugagro_readings.json",
        "fileContent": "={{ JSON.stringify($json.readings, null, 2) }}",
        "options": {
          "encoding": "utf8"
        }
      },
      "id": "save-readings",
      "name": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "operation": "write",
        "filePath": "/data/ugagro_alerts_history.json",
        "fileContent": "={{ JSON.stringify($json.alerts, null, 2) }}",
        "options": {
          "encoding": "utf8"
        }
      },
      "id": "save-alerts",
      "name": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [850, 450]
    },
    {
      "parameters": {
        "jsCode": "// –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–Ω–æ–π –∫–æ–ø–∏–∏\nconst readingsData = $node[\"–û—á–∏—Å—Ç–∏—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è\"].json;\nconst alertsData = $node[\"–û—á–∏—Å—Ç–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è\"].json;\n\nconst archiveDate = new Date().toISOString().split('T')[0];\nconst archive = {\n  date: archiveDate,\n  readings: {\n    removed: readingsData.removed,\n    remaining: readingsData.remaining\n  },\n  alerts: {\n    removed: alertsData.removed,\n    remaining: alertsData.remaining\n  },\n  timestamp: new Date().toISOString()\n};\n\nreturn [{ json: archive }];"
      },
      "id": "create-archive",
      "name": "–°–æ–∑–¥–∞—Ç—å –ê—Ä—Ö–∏–≤",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 375]
    },
    {
      "parameters": {
        "operation": "write",
        "filePath": "/data/cleanup_log.json",
        "fileContent": "={{ JSON.stringify($json, null, 2) }}\\n",
        "options": {
          "append": true,
          "encoding": "utf8"
        }
      },
      "id": "save-log",
      "name": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –õ–æ–≥",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [1250, 375]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "üßπ –ï–ñ–ï–î–ù–ï–í–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –î–ê–ù–ù–´–•\\n\\nüìä –ü–æ–∫–∞–∑–∞–Ω–∏—è:\\n  ‚Ä¢ –£–¥–∞–ª–µ–Ω–æ: {{ $json.readings.removed }}\\n  ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: {{ $json.readings.remaining }}\\n\\nüîî –û–ø–æ–≤–µ—â–µ–Ω–∏—è:\\n  ‚Ä¢ –£–¥–∞–ª–µ–Ω–æ: {{ $json.alerts.removed }}\\n  ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: {{ $json.alerts.remaining }}\\n\\n‚è∞ {{ $json.timestamp }}",
        "additionalFields": {}
      },
      "id": "notify-telegram",
      "name": "–£–≤–µ–¥–æ–º–∏—Ç—å –≤ Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1450, 375],
      "credentials": {
        "telegramApi": {
          "id": "2",
          "name": "Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Schedule Trigger (02:00)": {
      "main": [
        [
          {
            "node": "–ß–∏—Ç–∞—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è",
            "type": "main",
            "index": 0
          },
          {
            "node": "–ß–∏—Ç–∞—Ç—å –ò—Å—Ç–æ—Ä–∏—é –û–ø–æ–≤–µ—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ß–∏—Ç–∞—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–û—á–∏—Å—Ç–∏—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ß–∏—Ç–∞—Ç—å –ò—Å—Ç–æ—Ä–∏—é –û–ø–æ–≤–µ—â–µ–Ω–∏–π": {
      "main": [
        [
          {
            "node": "–û—á–∏—Å—Ç–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—á–∏—Å—Ç–∏—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—á–∏—Å—Ç–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ü–æ–∫–∞–∑–∞–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–°–æ–∑–¥–∞—Ç—å –ê—Ä—Ö–∏–≤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–°–æ–∑–¥–∞—Ç—å –ê—Ä—Ö–∏–≤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–°–æ–∑–¥–∞—Ç—å –ê—Ä—Ö–∏–≤": {
      "main": [
        [
          {
            "node": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –õ–æ–≥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –õ–æ–≥": {
      "main": [
        [
          {
            "node": "–£–≤–µ–¥–æ–º–∏—Ç—å –≤ Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-01-18T00:00:00.000Z",
  "versionId": "1"
}
