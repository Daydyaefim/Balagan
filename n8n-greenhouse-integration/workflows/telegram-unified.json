{
  "name": "Telegram Alerts Unified",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 20
            }
          ]
        }
      },
      "id": "schedule",
      "name": "Every 20 Seconds",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ]
      },
      "id": "telegram-trigger",
      "name": "Telegram Bot",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        240,
        600
      ],
      "webhookId": "telegram-callback-unified",
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ugagro_readings ORDER BY timestamp DESC LIMIT 1;",
        "options": {}
      },
      "id": "get-readings",
      "name": "Get Latest Readings",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        460,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º readings\nconst reading = $input.first().json;\n\n// –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ workflow static data (–æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö triggers!)\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.alertStates) {\n  staticData.alertStates = {};\n}\n\nconst states = staticData.alertStates;\n\n// –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è\nconst thresholds = {\n  high_temperature: { \n    field: 'outdoor_temperature', \n    max: 22, \n    message: 'üî• –ö–†–ò–¢–ò–ß–ù–û! –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è' \n  },\n  low_temperature: { \n    field: 'outdoor_temperature', \n    min: 18, \n    message: '‚ùÑÔ∏è –ö–†–ò–¢–ò–ß–ù–û! –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è' \n  },\n  high_humidity: { \n    field: 'outdoor_humidity', \n    max: 85, \n    message: 'üíß –ö–†–ò–¢–ò–ß–ù–û! –í–ª–∞–∂–Ω–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è' \n  },\n  low_humidity: { \n    field: 'outdoor_humidity', \n    min: 20, \n    message: 'üèúÔ∏è –ö–†–ò–¢–ò–ß–ù–û! –í–ª–∞–∂–Ω–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è' \n  },\n  low_water_level: { \n    field: 'water_level', \n    min: 5, \n    message: 'üö® –ö–†–ò–¢–ò–ß–ù–û! –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–π!' \n  }\n};\n\nconst alerts = [];\nconst now = new Date();\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–æ—Ä–æ–≥\nfor (const [alertType, config] of Object.entries(thresholds)) {\n  const value = parseFloat(reading[config.field]) || 0;\n  \n  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç\n  if (!states[alertType]) {\n    states[alertType] = { acknowledged: false, mutedUntil: null };\n  }\n  \n  const state = states[alertType];\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å\n  let isCritical = false;\n  if (config.max !== undefined && value > config.max) isCritical = true;\n  if (config.min !== undefined && value < config.min) isCritical = true;\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º muted\n  const isMuted = state.mutedUntil && new Date(state.mutedUntil) > now;\n  \n  // –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ –∏ –Ω–µ acknowledged –∏ –Ω–µ muted - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º\n  if (isCritical && !state.acknowledged && !isMuted) {\n    alerts.push({\n      alert_type: alertType,\n      message: config.message,\n      current_value: value,\n      threshold_min: config.min,\n      threshold_max: config.max,\n      outdoor_temperature: reading.outdoor_temperature,\n      outdoor_humidity: reading.outdoor_humidity,\n      water_level: reading.water_level\n    });\n  }\n  \n  // –ï—Å–ª–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º acknowledged\n  if (!isCritical && state.acknowledged) {\n    state.acknowledged = false;\n    state.mutedUntil = null;\n  }\n}\n\n// –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\nstaticData.alertStates = states;\n\nif (alerts.length === 0) {\n  return [];\n}\n\nreturn alerts.map(a => ({ json: a }));"
      },
      "id": "check-thresholds",
      "name": "Check Thresholds",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const alert = $input.first().json;\nconst chatId = '–£–ö–ê–ñ–ò–¢–ï_–í–ê–®_TELEGRAM_CHAT_ID';\n\nconst currentValue = parseFloat(alert.current_value) || 0;\n\nlet message = `${alert.message}\\n\\n`;\nmessage += `üìä *–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:* ${currentValue.toFixed(1)}\\n`;\n\nif (alert.threshold_min !== undefined) {\n  message += `‚ö†Ô∏è *–ú–∏–Ω–∏–º—É–º:* ${alert.threshold_min}\\n`;\n}\nif (alert.threshold_max !== undefined) {\n  message += `‚ö†Ô∏è *–ú–∞–∫—Å–∏–º—É–º:* ${alert.threshold_max}\\n`;\n}\n\nmessage += `\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmessage += `\\nüìã *–í–°–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:*\\n`;\nmessage += `üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${parseFloat(alert.outdoor_temperature).toFixed(1)}¬∞C\\n`;\nmessage += `üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${parseFloat(alert.outdoor_humidity).toFixed(1)}%\\n`;\nmessage += `üí¶ –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã: ${parseFloat(alert.water_level).toFixed(1)}%\\n`;\n\nreturn [{\n  json: {\n    chat_id: chatId,\n    text: message,\n    parse_mode: 'Markdown',\n    reply_markup: {\n      inline_keyboard: [[\n        {\n          text: '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å',\n          callback_data: `ack_${alert.alert_type}`\n        },\n        {\n          text: 'üîï –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞ 1—á',\n          callback_data: `mute_${alert.alert_type}_1h`\n        }\n      ]]\n    }\n  }\n}];"
      },
      "id": "format-message",
      "name": "Format Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $credentials.telegramApi.accessToken }}/sendMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "telegramApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "send-telegram",
      "name": "Send to Telegram",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1120,
        300
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// –§–∏–ª—å—Ç—Ä –¥–ª—è callback - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ callback_query\nconst isCallback = data.callback_query !== undefined && data.callback_query !== null;\n\nreturn isCallback ? [{ json: data }] : [];"
      },
      "id": "filter-callback",
      "name": "Filter Callback",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// –§–∏–ª—å—Ç—Ä –¥–ª—è message - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ callback)\nconst isMessage = data.message !== undefined && data.message !== null && !data.callback_query;\n\nreturn isMessage ? [{ json: data }] : [];"
      },
      "id": "filter-message",
      "name": "Filter Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        700
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst chatId = data.message.chat.id;\nconst command = data.message.text;\n\nlet responseText = '';\n\nif (command === '/start') {\n    responseText = 'üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç–µ–ø–ª–∏—Ü—ã.\\n\\n';\n    responseText += '–ö–æ–º–∞–Ω–¥—ã:\\n';\n    responseText += '/status - —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ\\n';\n    responseText += '/poliv - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–∏–≤–µ\\n';\n    responseText += '/help - –ø–æ–º–æ—â—å';\n} \nelse if (command === '/help') {\n    responseText = '‚ùì *–ü–æ–º–æ—â—å*\\n\\n';\n    responseText += '–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è:\\n';\n    responseText += '‚Ä¢ üî• –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞\\n';\n    responseText += '‚Ä¢ ‚ùÑÔ∏è –ù–∏–∑–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞\\n';\n    responseText += '‚Ä¢ üíß –í—ã—Å–æ–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å\\n';\n    responseText += '‚Ä¢ üèúÔ∏è –ù–∏–∑–∫–∞—è –≤–ª–∞–∂–Ω–æ—Å—Ç—å\\n';\n    responseText += '‚Ä¢ üö® –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã\\n\\n';\n    responseText += '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π.';\n}\nelse {\n    responseText = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.';\n}\n\nreturn [{\n    json: {\n        chat_id: chatId,\n        text: responseText,\n        parse_mode: 'Markdown'\n    }\n}];"
      },
      "id": "process-simple-commands",
      "name": "Process Simple Commands",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        700
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "regex",
              "value2": "^/(status|poliv)$"
            }
          ]
        }
      },
      "id": "if-needs-data",
      "name": "Needs Data?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        680,
        650
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ugagro_readings ORDER BY timestamp DESC LIMIT 1;",
        "options": {}
      },
      "id": "get-readings-for-command",
      "name": "Get Readings For Command",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        900,
        550
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–ª—É—á–∞–µ–º trigger data –æ—Ç Filter Message –∏ DB data –æ—Ç PostgreSQL\nconst triggerData = $('Filter Message').first().json;\nconst dbData = $input.first().json;\n\nconst chatId = triggerData.message.chat.id;\nconst command = triggerData.message.text;\n\nlet message = '';\n\nif (command === '/status') {\n  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —á–∏—Å–ª–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞\n  const temp = parseFloat(dbData.temperature) || 0;\n  const hum = parseFloat(dbData.humidity) || 0;\n  const water = parseFloat(dbData.water_level) || 0;\n  const outdoorTemp = parseFloat(dbData.outdoor_temperature) || null;\n  const pyrano = parseFloat(dbData.pyrano) || 0;\n  const windowPos = parseInt(dbData.window_position) || 0;\n  \n  message = `üå± *–¢–ï–ü–õ–ò–¶–ê 1*\\n\\n`;\n  message += `üå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:* ${temp.toFixed(1)}¬∞C\\n`;\n  message += `üíß *–í–ª–∞–∂–Ω–æ—Å—Ç—å:* ${hum.toFixed(1)}%\\n`;\n  message += `üå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —É–ª–∏—Ü—ã:* ${outdoorTemp ? outdoorTemp.toFixed(1) + '¬∞C' : '–Ω/–¥'}\\n`;\n  message += `üí¶ *–£—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Ç–≤–æ—Ä–∞:* ${water.toFixed(1)}%\\n`;\n  message += `‚òÄÔ∏è *–¢–µ–∫—É—â–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${pyrano.toFixed(0)} –í—Ç/–º¬≤\\n`;\n  message += `ü™ü *–ü–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–æ—Ä—Ç–æ—á–∫–∏:* ${windowPos}%\\n`;\n  message += `üïí *–í—Ä–µ–º—è ESP32:* ${new Date(dbData.timestamp_iso).toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}`;\n  \n} else if (command === '/poliv') {\n  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª–∏–≤–∞\n  const wateringMode = parseInt(dbData.watering_mode) || 0;\n  const pyrano = parseFloat(dbData.pyrano) || 0;\n  const radSum = parseFloat(dbData.rad_sum) || 0;\n  const wateringDuration = parseInt(dbData.watering_duration_sec) || 200;\n  const radThreshold = parseFloat(dbData.rad_threshold) || 1.1;\n  const maxInterval = parseInt(dbData.max_interval_minutes) || 90;\n  const lastWateringUnix = parseInt(dbData.last_watering_start_unix) || 0;\n  const cycleCount = parseInt(dbData.cycle_count) || 0;\n  const forceActive = dbData.force_watering_active || false;\n  \n  // –û–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤\n  const windowStart = dbData.watering_window_start || '07:40:00';\n  const windowEnd = dbData.watering_window_end || '17:20:00';\n  \n  // –ù–∞–∑–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ (0=–ê–≤—Ç–æ, 1=–†—É—á–Ω–æ–π, 2=–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π)\n  const modeNames = {\n    0: 'ü§ñ –ê–≤—Ç–æ',\n    1: '‚öôÔ∏è –†—É—á–Ω–æ–π',\n    2: 'üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π'\n  };\n  \n  const modeName = modeNames[wateringMode] || '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';\n  \n  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º radSum –∏–∑ J/m¬≤ –≤ MJ/m¬≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\n  const radSumMJ = radSum / 1000000;\n  \n  // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–∏–≤–∞\n  let nextWateringInfo = '';\n  const now = Math.floor(Date.now() / 1000);\n  const timeSinceLastWatering = lastWateringUnix > 0 ? now - lastWateringUnix : 0;\n  const minutesSinceLast = Math.floor(timeSinceLastWatering / 60);\n  \n  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ú–æ—Å–∫–≤—ã\n  const currentHour = parseInt(new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', hour: 'numeric', hour12: false }));\n  const currentMinute = parseInt(new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', minute: 'numeric' }));\n  const currentMin = currentHour * 60 + currentMinute;\n  \n  // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –æ–∫–Ω–∞ –ø–æ–ª–∏–≤–æ–≤\n  const [startH, startM] = windowStart.split(':').map(Number);\n  const [endH, endM] = windowEnd.split(':').map(Number);\n  const startMin = startH * 60 + startM;\n  const endMin = endH * 60 + endM;\n  const isInWindow = currentMin >= startMin && currentMin < endMin;\n  \n  if (wateringMode === 0) {\n    // –ê–≤—Ç–æ —Ä–µ–∂–∏–º - –ø–æ —Ä–∞–¥–∏–∞—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞\n    const radNeeded = (radThreshold * 1000000) - radSum; // radThreshold –≤ MJ, radSum –≤ J\n    \n    if (radNeeded <= 0) {\n      nextWateringInfo = '—Å–∫–æ—Ä–æ (—Ä–∞–¥–∏–∞—Ü–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∞)';\n    } else if (pyrano > 0) {\n      // –†–∞—Å—á–µ—Ç –ø–æ —Ä–∞–¥–∏–∞—Ü–∏–∏\n      const secondsNeeded = Math.floor(radNeeded / pyrano);\n      const minutesNeeded = Math.floor(secondsNeeded / 60);\n      \n      if (minutesNeeded <= maxInterval) {\n        const hours = Math.floor(minutesNeeded / 60);\n        const mins = minutesNeeded % 60;\n        nextWateringInfo = hours > 0 ? `~—á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω` : `~—á–µ—Ä–µ–∑ ${mins}–º–∏–Ω`;\n      } else {\n        nextWateringInfo = `–º–∞–∫—Å. —á–µ—Ä–µ–∑ ${Math.floor(maxInterval / 60)}—á ${maxInterval % 60}–º–∏–Ω`;\n      }\n    } else {\n      // –ù–µ—Ç —Å–æ–ª–Ω—Ü–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å. –∏–Ω—Ç–µ—Ä–≤–∞–ª\n      const minutesUntilMax = maxInterval - minutesSinceLast;\n      if (minutesUntilMax > 0) {\n        const hours = Math.floor(minutesUntilMax / 60);\n        const mins = minutesUntilMax % 60;\n        nextWateringInfo = hours > 0 ? `—á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω (–º–∞–∫—Å. –∏–Ω—Ç–µ—Ä–≤–∞–ª)` : `—á–µ—Ä–µ–∑ ${mins}–º–∏–Ω`;\n      } else {\n        nextWateringInfo = '—Å–∫–æ—Ä–æ (–º–∞–∫—Å. –∏–Ω—Ç–µ—Ä–≤–∞–ª)';\n      }\n    }\n  } else if (wateringMode === 1) {\n    // –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º - –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É\n    const manualInterval = parseInt(dbData.manual_interval_minutes) || 60;\n    const minutesUntilNext = manualInterval - minutesSinceLast;\n    \n    if (minutesUntilNext > 0) {\n      const hours = Math.floor(minutesUntilNext / 60);\n      const mins = minutesUntilNext % 60;\n      nextWateringInfo = hours > 0 ? `—á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω` : `—á–µ—Ä–µ–∑ ${mins}–º–∏–Ω`;\n    } else {\n      nextWateringInfo = '—Å–∫–æ—Ä–æ';\n    }\n  } else if (wateringMode === 2) {\n    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º\n    nextWateringInfo = forceActive ? '–∏–¥–µ—Ç —Å–µ–π—á–∞—Å' : '–ø–æ –∫–æ–º–∞–Ω–¥–µ';\n  }\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–∏–≤–∞ (–∫—Ä–æ–º–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ)\n  if (!isInWindow && wateringMode !== 2) {\n    nextWateringInfo = '–≤–Ω–µ –æ–∫–Ω–∞ –ø–æ–ª–∏–≤–æ–≤';\n  }\n  \n  // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\n  message = `üíß *–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–ò–í–ï*\\n\\n`;\n  message += `‚öôÔ∏è *–†–µ–∂–∏–º:* ${modeName}\\n`;\n  message += `‚òÄÔ∏è *–¢–µ–∫—É—â–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${pyrano.toFixed(0)} –í—Ç/–º¬≤\\n`;\n  message += `üìä *–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${radSumMJ.toFixed(2)} –ú–î–∂/–º¬≤\\n`;\n  message += `üéØ *–ü–æ—Ä–æ–≥ —Ä–∞–¥–∏–∞—Ü–∏–∏:* ${radThreshold.toFixed(1)} –ú–î–∂/–º¬≤\\n`;\n  message += `‚è±Ô∏è *–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞:* ${wateringDuration} —Å–µ–∫\\n`;\n  message += `üîÑ *–¶–∏–∫–ª–æ–≤ –ø–æ–ª–∏–≤–∞ —Å–µ–≥–æ–¥–Ω—è:* ${cycleCount}\\n`;\n  message += `\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n\\n`;\n  message += `‚è∞ *–°–õ–ï–î–£–Æ–©–ò–ô –ü–û–õ–ò–í:*\\n${nextWateringInfo}\\n\\n`;\n  message += `‚è≥ *–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:* ${Math.floor(maxInterval / 60)}—á ${maxInterval % 60}–º–∏–Ω\\n`;\n  message += `üïê *–û–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤:* ${windowStart.substring(0, 5)} - ${windowEnd.substring(0, 5)}\\n`;\n  \n  if (lastWateringUnix > 0) {\n    message += `\\nüïí *–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤:* ${new Date(lastWateringUnix * 1000).toLocaleString('ru-RU')}`;\n  }\n}\n\nreturn [{\n  json: {\n    chat_id: chatId,\n    text: message,\n    parse_mode: 'Markdown'\n  }\n}];"
      },
      "id": "format-data-command",
      "name": "Format Data Command",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        550
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// –ü–æ–ª—É—á–∞–µ–º chat_id –∏–∑ callback_query –∏–ª–∏ message\nlet chatId;\nif (data.callback_query && data.callback_query.message && data.callback_query.message.chat) {\n  chatId = data.callback_query.message.chat.id;\n} else if (data.message && data.message.chat) {\n  chatId = data.message.chat.id;\n} else {\n  console.error('–ù–µ –Ω–∞–π–¥–µ–Ω chat_id. –î–∞–Ω–Ω—ã–µ:', JSON.stringify(data));\n  return [];\n}\n\n// –ü–æ–ª—É—á–∞–µ–º callback_data –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç\nlet callbackData = '';\nif (data.callback_query && data.callback_query.data) {\n  callbackData = data.callback_query.data;\n} else if (data.callback_data) {\n  callbackData = data.callback_data;\n} else if (data.data) {\n  callbackData = data.data;\n}\n\n// –ï—Å–ª–∏ –Ω–µ—Ç callback_data - –æ—à–∏–±–∫–∞\nif (!callbackData) {\n  console.error('–ù–µ –Ω–∞–π–¥–µ–Ω callback_data. –î–∞–Ω–Ω—ã–µ:', JSON.stringify(data));\n  return [];\n}\n\n// –ü–∞—Ä—Å–∏–º: \"ack_high_temperature\" –∏–ª–∏ \"mute_high_temperature_1h\"\nlet alertType = '';\nlet action = '';\n\nif (callbackData.startsWith('ack_')) {\n  action = 'ack';\n  alertType = callbackData.substring(4);\n} else if (callbackData.startsWith('mute_')) {\n  action = 'mute';\n  const parts = callbackData.substring(5).split('_');\n  alertType = parts.slice(0, -1).join('_');\n}\n\n// –û–±–Ω–æ–≤–ª—è–µ–º staticData\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.alertStates) {\n  staticData.alertStates = {};\n}\n\nif (!staticData.alertStates[alertType]) {\n  staticData.alertStates[alertType] = { acknowledged: false, mutedUntil: null };\n}\n\nconst state = staticData.alertStates[alertType];\nlet responseText = '';\n\nif (action === 'ack') {\n  state.acknowledged = true;\n  responseText = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ. –°–ø–∞–º –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–æ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —É—Å–ª–æ–≤–∏–π.';\n} else if (action === 'mute') {\n  const now = new Date();\n  const muteUntil = new Date(now.getTime() + 60 * 60 * 1000);\n  state.mutedUntil = muteUntil.toISOString();\n  state.acknowledged = true;\n  responseText = 'üîï –û–ø–æ–≤–µ—â–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã –Ω–∞ 1 —á–∞—Å.';\n}\n\nstaticData.alertStates[alertType] = state;\n\n// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—ã—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è\nreturn [{\n  json: {\n    chat_id: chatId,\n    text: responseText,\n    parse_mode: 'Markdown'\n  }\n}];"
      },
      "id": "process-callback",
      "name": "Process Callback",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        460,
        600
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $credentials.telegramApi.accessToken }}/sendMessage",
        "authentication": "genericCredentialType",
        "genericAuthType": "telegramApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "id": "send-confirmation",
      "name": "Send Confirmation",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        680,
        600
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "Telegram Bot API"
        }
      }
    }
  ],
  "connections": {
    "Every 20 Seconds": {
      "main": [
        [
          {
            "node": "Get Latest Readings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Latest Readings": {
      "main": [
        [
          {
            "node": "Check Thresholds",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Thresholds": {
      "main": [
        [
          {
            "node": "Format Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Message": {
      "main": [
        [
          {
            "node": "Send to Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Callback": {
      "main": [
        [
          {
            "node": "Send Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Bot": {
      "main": [
        [
          {
            "node": "Filter Callback",
            "type": "main",
            "index": 0
          },
          {
            "node": "Filter Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Callback": {
      "main": [
        [
          {
            "node": "Process Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Message": {
      "main": [
        [
          {
            "node": "Needs Data?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Needs Data?": {
      "main": [
        [
          {
            "node": "Get Readings For Command",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Process Simple Commands",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Readings For Command": {
      "main": [
        [
          {
            "node": "Format Data Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Data Command": {
      "main": [
        [
          {
            "node": "Send Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Simple Commands": {
      "main": [
        [
          {
            "node": "Send Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-20T00:00:00.000Z",
  "versionId": "1"
}