{
  "name": "Database Migrations - Watering & Connection Lost",
  "nodes": [
    {
      "parameters": {},
      "id": "manual-trigger",
      "name": "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ú–∏–≥—Ä–∞—Ü–∏—é",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª–∏–≤–∞\nCREATE TABLE IF NOT EXISTS watering_settings (\n    id SERIAL PRIMARY KEY,\n    rad_threshold DECIMAL(10,2) DEFAULT 1.1,\n    watering_duration_sec INTEGER DEFAULT 200,\n    max_interval_minutes INTEGER DEFAULT 90,\n    watering_window_start TIME DEFAULT '07:40:00',\n    watering_window_end TIME DEFAULT '17:20:00',\n    manual_interval_minutes INTEGER DEFAULT 60,\n    morning_count INTEGER DEFAULT 3,\n    morning_start_time TIME DEFAULT '07:40:00',\n    morning_interval_minutes INTEGER DEFAULT 30,\n    updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\n-- –í—Å—Ç–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é\nINSERT INTO watering_settings (\n    rad_threshold,\n    watering_duration_sec,\n    max_interval_minutes,\n    watering_window_start,\n    watering_window_end,\n    manual_interval_minutes,\n    morning_count,\n    morning_start_time,\n    morning_interval_minutes\n) VALUES (\n    1.1,\n    200,\n    90,\n    '07:40:00',\n    '17:20:00',\n    60,\n    3,\n    '07:40:00',\n    30\n)\nON CONFLICT DO NOTHING;\n\nSELECT 'watering_settings created' as result;",
        "options": {}
      },
      "id": "create-watering-settings",
      "name": "1. –°–æ–∑–¥–∞—Ç—å watering_settings",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        460,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ–ª–∏–≤–µ\nCREATE TABLE IF NOT EXISTS watering_notifications (\n    id SERIAL PRIMARY KEY,\n    last_pump_state BOOLEAN DEFAULT FALSE,\n    last_check_timestamp TIMESTAMP NOT NULL DEFAULT NOW(),\n    last_notification_type VARCHAR(20),\n    last_notification_sent_at TIMESTAMP,\n    notifications_count INTEGER DEFAULT 0,\n    last_watering_start TIMESTAMP,\n    last_watering_end TIMESTAMP,\n    last_watering_duration_sec INTEGER,\n    updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\n-- –í—Å—Ç–∞–≤–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ\nINSERT INTO watering_notifications (\n    last_pump_state,\n    last_check_timestamp\n) VALUES (\n    FALSE,\n    NOW()\n)\nON CONFLICT DO NOTHING;\n\nSELECT 'watering_notifications created' as result;",
        "options": {}
      },
      "id": "create-watering-notifications",
      "name": "2. –°–æ–∑–¥–∞—Ç—å watering_notifications",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        680,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–∏–ø –æ–ø–æ–≤–µ—â–µ–Ω–∏—è - –ø–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏ —Å ESP32\nINSERT INTO telegram_alert_states (alert_type, is_active) VALUES\n    ('esp32_connection_lost', FALSE)\nON CONFLICT (alert_type) DO NOTHING;\n\nSELECT 'esp32_connection_lost alert added' as result;",
        "options": {}
      },
      "id": "add-connection-lost-alert",
      "name": "3. –î–æ–±–∞–≤–∏—Ç—å esp32_connection_lost",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        900,
        200
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ —Ä–∞–±–æ—Ç—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è\nALTER TABLE ugagro_readings\n    ADD COLUMN IF NOT EXISTS fan_mode VARCHAR(20) DEFAULT 'auto',\n    ADD COLUMN IF NOT EXISTS heat_mode VARCHAR(20) DEFAULT 'auto',\n    ADD COLUMN IF NOT EXISTS fog_mode VARCHAR(20) DEFAULT 'auto',\n    ADD COLUMN IF NOT EXISTS hydro_mix_mode VARCHAR(20) DEFAULT 'auto';\n-- –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü –¥–ª—è —Å–æ–ª–Ω–µ—á–Ω–æ–π —Ä–∞–¥–∏–∞—Ü–∏–∏ (–∞–ª–∏–∞—Å –¥–ª—è pyrano)\nALTER TABLE ugagro_readings\n    ADD COLUMN IF NOT EXISTS solar_radiation DECIMAL(5,2);\n-- –°–æ–∑–¥–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ solar_radiation –∏ pyrano\nCREATE OR REPLACE FUNCTION sync_solar_radiation() RETURNS TRIGGER AS $$\nBEGIN\n    IF NEW.pyrano IS NOT NULL THEN\n        NEW.solar_radiation := NEW.pyrano;\n    END IF;\n    IF NEW.solar_radiation IS NOT NULL THEN\n        NEW.pyrano := NEW.solar_radiation;\n    END IF;\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\nDROP TRIGGER IF EXISTS trigger_sync_solar_radiation ON ugagro_readings;\nCREATE TRIGGER trigger_sync_solar_radiation\n    BEFORE INSERT OR UPDATE ON ugagro_readings\n    FOR EACH ROW\n    EXECUTE FUNCTION sync_solar_radiation();\n-- –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏\nUPDATE ugagro_readings SET solar_radiation = pyrano WHERE solar_radiation IS NULL;\nSELECT 'equipment_modes_migration_completed' as result;",
        "options": {}
      },
      "id": "add-equipment-modes",
      "name": "4. –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∂–∏–º—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        900,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –∏ –¥–∞–Ω–Ω—ã—Ö\nSELECT 'watering_settings' as table_name, COUNT(*) as row_count FROM watering_settings\nUNION ALL\nSELECT 'watering_notifications' as table_name, COUNT(*) as row_count FROM watering_notifications\nUNION ALL\nSELECT 'telegram_alert_states (esp32_connection_lost)' as table_name, COUNT(*) as row_count\nFROM telegram_alert_states WHERE alert_type = 'esp32_connection_lost'\nUNION ALL\nSELECT 'ugagro_readings (equipment modes)' as table_name,\n       COUNT(*) FILTER (WHERE fan_mode IS NOT NULL) as row_count\nFROM ugagro_readings\nUNION ALL\nSELECT 'ugagro_readings (solar_radiation)' as table_name,\n       COUNT(*) FILTER (WHERE solar_radiation IS NOT NULL) as row_count\nFROM ugagro_readings;",
        "options": {}
      },
      "id": "verify-migrations",
      "name": "5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç—ã",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1120,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏\nconst results = $input.all().map(i => i.json);\n\nlet message = '‚úÖ *–ú–ò–ì–†–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• –ó–ê–í–ï–†–®–ï–ù–ê*\\n\\n';\nmessage += 'üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:*\\n\\n';\n\nresults.forEach(result => {\n  if (Array.isArray(result)) {\n    result.forEach(row => {\n      message += `  ‚Ä¢ ${row.table_name}: ${row.row_count} –∑–∞–ø–∏—Å–µ–π\\n`;\n    });\n  } else {\n    message += `  ‚Ä¢ ${result.result || 'OK'}\\n`;\n  }\n});\n\nmessage += '\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n';\nmessage += '\\nüéâ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!\\n';\nmessage += '\\n*–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:*\\n';\nmessage += '1. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ workflow\\n';\nmessage += '2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å TELEGRAM_CHAT_ID –≤ workflow —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\\n';\nmessage += '3. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ workflow\\n';\n\nconsole.log(message);\n\nreturn [{ json: { message, success: true } }];"
      },
      "id": "format-results",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç—ã",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1340,
        300
      ]
    }
  ],
  "connections": {
    "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ú–∏–≥—Ä–∞—Ü–∏—é": {
      "main": [
        [
          {
            "node": "1. –°–æ–∑–¥–∞—Ç—å watering_settings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. –°–æ–∑–¥–∞—Ç—å watering_settings": {
      "main": [
        [
          {
            "node": "2. –°–æ–∑–¥–∞—Ç—å watering_notifications",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2. –°–æ–∑–¥–∞—Ç—å watering_notifications": {
      "main": [
        [
          {
            "node": "3. –î–æ–±–∞–≤–∏—Ç—å esp32_connection_lost",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. –î–æ–±–∞–≤–∏—Ç—å esp32_connection_lost": {
      "main": [
        [
          {
            "node": "4. –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∂–∏–º—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∂–∏–º—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è": {
      "main": [
        [
          {
            "node": "5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç—ã",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç—ã": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –†–µ–∑—É–ª—å—Ç–∞—Ç—ã",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-19T00:00:00.000Z",
  "versionId": "1"
}