{
  "name": "Telegram - Critical Alerts",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 20
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Every 20 Seconds",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ugagro_readings\nORDER BY timestamp DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-latest",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM telegram_alert_states;",
        "options": {}
      },
      "id": "get-alert-states",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏—è –û–ø–æ–≤–µ—â–µ–Ω–∏–π",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [680, 300],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const reading = $node[\"–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ\"].json;\nconst states = $input.all().map(i => i.json);\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞\nconst statesMap = {};\nstates.forEach(s => {\n  statesMap[s.alert_type] = s;\n});\n\n// –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è\nconst thresholds = {\n  high_temperature: { field: 'temperature', max: 40, message: 'üî• –ö–†–ò–¢–ò–ß–ù–û! –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è' },\n  low_temperature: { field: 'temperature', min: 10, message: '‚ùÑÔ∏è –ö–†–ò–¢–ò–ß–ù–û! –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è' },\n  high_humidity: { field: 'humidity', max: 85, message: 'üíß –ö–†–ò–¢–ò–ß–ù–û! –í–ª–∞–∂–Ω–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è' },\n  low_humidity: { field: 'humidity', min: 20, message: 'üèúÔ∏è –ö–†–ò–¢–ò–ß–ù–û! –í–ª–∞–∂–Ω–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è' },\n  low_water_level: { field: 'water_level', min: 5, message: 'üö® –ö–†–ò–¢–ò–ß–ù–û! –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã –æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–π!' },\n  high_wind_speed: { field: 'wind_speed', max: 11, message: 'üí® –ö–†–ò–¢–ò–ß–ù–û! –°–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä!' }\n};\n\nconst alerts = [];\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ —É—Å–ª–æ–≤–∏–µ\nfor (const [alertType, config] of Object.entries(thresholds)) {\n  const value = parseFloat(reading[config.field]) || 0;\n  const state = statesMap[alertType];\n  \n  let isCritical = false;\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥–∏\n  if (config.max !== undefined && value > config.max) {\n    isCritical = true;\n  }\n  if (config.min !== undefined && value < config.min) {\n    isCritical = true;\n  }\n  \n  // –ü—Ä–æ–≤–µ—Ä—è–µ–º mute_until (–µ—Å–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ –Ω–∞ –≤—Ä–µ–º—è)\n  const isMuted = state && state.mute_until && new Date(state.mute_until) > new Date();\n  \n  // –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ –∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∏ –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ\n  if (isCritical && (!state || !state.is_active || !state.acknowledged_at) && !isMuted) {\n    alerts.push({\n      alert_type: alertType,\n      message: config.message,\n      field: config.field,\n      current_value: value,\n      threshold_min: config.min,\n      threshold_max: config.max,\n      timestamp: reading.timestamp_iso,\n      is_new: !state || !state.is_active\n    });\n  }\n  \n  // –ï—Å–ª–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –Ω–æ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ - –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º\n  if (!isCritical && state && state.is_active) {\n    alerts.push({\n      alert_type: alertType,\n      action: 'deactivate'\n    });\n  }\n}\n\nif (alerts.length === 0) {\n  // –ù–µ—Ç –æ–ø–æ–≤–µ—â–µ–Ω–∏–π\n  return [];\n}\n\nreturn alerts.map(a => ({ json: a }));"
      },
      "id": "check-thresholds",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ü–æ—Ä–æ–≥–æ–≤",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.action }}",
              "rightValue": "deactivate",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ]
        }
      },
      "id": "filter-active-alerts",
      "name": "–¢–æ–ª—å–∫–æ –ê–∫—Ç–∏–≤–Ω—ã–µ",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "const alert = $json;\nconst reading = $node[\"–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ\"].json;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\nlet message = `${alert.message}\\n\\n`;\nmessage += `üìä *–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:* ${alert.current_value.toFixed(1)}\\n`;\n\nif (alert.threshold_min !== undefined) {\n  message += `‚ö†Ô∏è *–ú–∏–Ω–∏–º—É–º:* ${alert.threshold_min}\\n`;\n}\nif (alert.threshold_max !== undefined) {\n  message += `‚ö†Ô∏è *–ú–∞–∫—Å–∏–º—É–º:* ${alert.threshold_max}\\n`;\n}\n\nmessage += `\\nüïí *–í—Ä–µ–º—è:* ${new Date(alert.timestamp).toLocaleString('ru-RU')}\\n`;\nmessage += `\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmessage += `\\nüìã *–í–°–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:*\\n`;\nmessage += `üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${parseFloat(reading.temperature).toFixed(1)}¬∞C\\n`;\nmessage += `üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${parseFloat(reading.humidity).toFixed(1)}%\\n`;\nmessage += `üí¶ –£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã: ${parseFloat(reading.water_level).toFixed(1)}%\\n`;\nmessage += `üí® –í–µ—Ç–µ—Ä: ${parseFloat(reading.wind_speed).toFixed(1)} –º/—Å\\n`;\n\nreturn [{\n  json: {\n    message: message,\n    alert_type: alert.alert_type,\n    current_value: alert.current_value,\n    is_new: alert.is_new\n  }\n}];"
      },
      "id": "format-alert",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "chatId": "=–£–ö–ê–ñ–ò–¢–ï_–í–ê–®_TELEGRAM_CHAT_ID",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parseMode": "Markdown",
          "replyMarkup": "inlineKeyboard",
          "inlineKeyboard": {
            "rows": [
              {
                "row": {
                  "buttons": [
                    {
                      "button": {
                        "text": "‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å",
                        "callbackData": "=ack_{{ $json.alert_type }}"
                      }
                    },
                    {
                      "button": {
                        "text": "üîï –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞ 1—á",
                        "callbackData": "=mute_{{ $json.alert_type }}_1h"
                      }
                    }
                  ]
                }
              }
            ]
          }
        }
      },
      "id": "send-alert",
      "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1560, 200],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è\nconst alertType = $json.alert_type || 'unknown';\nconst currentValue = $json.current_value || 0;\nconst message = ($json.message || '').replace(/'/g, \"''\");\n\nconst sqlQuery = `UPDATE telegram_alert_states\nSET \n  is_active = true,\n  last_sent_at = NOW(),\n  current_value = ${currentValue},\n  alert_count = alert_count + 1,\n  updated_at = NOW()\nWHERE alert_type = '${alertType}';\n\n-- –î–æ–±–∞–≤–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–æ–≤–æ–µ\nINSERT INTO ugagro_alerts_history (\n  alert_type,\n  alert_message,\n  sensor_value,\n  severity,\n  created_at\n) VALUES (\n  '${alertType}',\n  '${message}',\n  ${currentValue},\n  'critical',\n  NOW()\n);`;\n\nreturn [{ json: { sql_query: sqlQuery, alert_type: alertType } }];"
      },
      "id": "prepare-update-sql",
      "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û–±–Ω–æ–≤–ª–µ–Ω–∏—è",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sql_query }}",
        "options": {}
      },
      "id": "update-state",
      "name": "–û–±–Ω–æ–≤–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏–µ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2000, 200],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏\nconst alertType = $json.alert_type || 'unknown';\n\nconst sqlQuery = `UPDATE telegram_alert_states\nSET \n  is_active = false,\n  acknowledged_at = NOW(),\n  updated_at = NOW()\nWHERE alert_type = '${alertType}';`;\n\nreturn [{ json: { sql_query: sqlQuery, alert_type: alertType } }];"
      },
      "id": "prepare-deactivate-sql",
      "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sql_query }}",
        "options": {}
      },
      "id": "deactivate-alert",
      "name": "–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1560, 400],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    }
  ],
  "connections": {
    "Schedule Every 20 Seconds": {
      "main": [
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ": {
      "main": [
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏—è –û–ø–æ–≤–µ—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏—è –û–ø–æ–≤–µ—â–µ–Ω–∏–π": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ü–æ—Ä–æ–≥–æ–≤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ü–æ—Ä–æ–≥–æ–≤": {
      "main": [
        [
          {
            "node": "–¢–æ–ª—å–∫–æ –ê–∫—Ç–∏–≤–Ω—ã–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–¢–æ–ª—å–∫–æ –ê–∫—Ç–∏–≤–Ω—ã–µ": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û–±–Ω–æ–≤–ª–µ–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û–±–Ω–æ–≤–ª–µ–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–û–±–Ω–æ–≤–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏": {
      "main": [
        [
          {
            "node": "–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-18T00:00:00.000Z",
  "versionId": "1"
}
