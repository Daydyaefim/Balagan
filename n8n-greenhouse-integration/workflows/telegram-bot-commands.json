{
  "name": "Telegram Bot - Commands",
  "nodes": [
    {
      "parameters": {
        "updates": ["message"]
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [240, 300],
      "webhookId": "telegram-ugagro-bot",
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "/status",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "/—Å—Ç–∞—Ç—É—Å",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        }
      },
      "id": "check-command",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–æ–º–∞–Ω–¥—ã",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ugagro_readings\nORDER BY timestamp DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-latest-data",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [680, 200],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst chatId = $node[\"Telegram Trigger\"].json.message.chat.id;\n\n// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ —Å—Ç–∞—Ç—É—Å–∞\nfunction getStatusEmoji(type, value) {\n  const thresholds = {\n    temperature: { min: 10, max: 40 },\n    humidity: { min: 20, max: 85 },\n    water_level: { min: 5 },\n    wind_speed: { max: 11 }\n  };\n  \n  if (type === 'temperature') {\n    if (value < thresholds.temperature.min || value > thresholds.temperature.max) return 'üî¥';\n    return 'üü¢';\n  } else if (type === 'humidity') {\n    if (value < thresholds.humidity.min || value > thresholds.humidity.max) return 'üî¥';\n    return 'üü¢';\n  } else if (type === 'water_level') {\n    if (value < thresholds.water_level.min) return 'üî¥';\n    if (value < 15) return 'üü°';\n    return 'üü¢';\n  } else if (type === 'wind_speed') {\n    if (value > thresholds.wind_speed.max) return 'üî¥';\n    if (value > 8) return 'üü°';\n    return 'üü¢';\n  }\n  return '‚ö™';\n}\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —á–∏—Å–ª–∞\nconst temp = parseFloat(data.temperature) || 0;\nconst hum = parseFloat(data.humidity) || 0;\nconst water = parseFloat(data.water_level) || 0;\nconst wind = parseFloat(data.wind_speed) || 0;\nconst outdoorTemp = parseFloat(data.outdoor_temperature) || null;\nconst outdoorHum = parseFloat(data.outdoor_humidity) || null;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\nconst message = `üå± *UGAGRO 95 - –°–¢–ê–¢–£–° –¢–ï–ü–õ–ò–¶–´*\n\nüìä *–û–°–ù–û–í–ù–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò:*\n\n${getStatusEmoji('temperature', temp)} *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:* ${temp.toFixed(1)}¬∞C\n   ‚îî –ù–æ—Ä–º–∞: 10-40¬∞C\n\n${getStatusEmoji('humidity', hum)} *–í–ª–∞–∂–Ω–æ—Å—Ç—å:* ${hum.toFixed(1)}%\n   ‚îî –ù–æ—Ä–º–∞: 20-85%\n\n${getStatusEmoji('water_level', water)} *–£—Ä–æ–≤–µ–Ω—å –≤–æ–¥—ã:* ${water.toFixed(1)}%\n   ‚îî –ö—Ä–∏—Ç–∏—á–Ω–æ: <5%, –í–Ω–∏–º–∞–Ω–∏–µ: <15%\n\n${getStatusEmoji('wind_speed', wind)} *–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞:* ${wind.toFixed(1)} –º/—Å\n   ‚îî –ö—Ä–∏—Ç–∏—á–Ω–æ: >11 –º/—Å, –í–Ω–∏–º–∞–Ω–∏–µ: >8 –º/—Å\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüå°Ô∏è *–£–õ–ò–¶–ê:*\n   –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${outdoorTemp ? outdoorTemp.toFixed(1) + '¬∞C' : '–Ω/–¥'}\n   –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${outdoorHum ? outdoorHum.toFixed(1) + '%' : '–Ω/–¥'}\n\n‚öôÔ∏è *–û–ë–û–†–£–î–û–í–ê–ù–ò–ï:*\n   ${data.fan_state ? '‚úÖ' : '‚ùå'} –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä\n   ${data.heat_state ? '‚úÖ' : '‚ùå'} –û–±–æ–≥—Ä–µ–≤\n   ${data.pump_state ? '‚úÖ' : '‚ùå'} –ù–∞—Å–æ—Å\n   ${data.fog_state ? '‚úÖ' : '‚ùå'} –¢—É–º–∞–Ω\n\nü™ü *–û–∫–Ω–æ:* ${data.window_position || 0}%\n‚òÄÔ∏è *–ü–∏—Ä–∞–Ω–æ–º–µ—Ç—Ä:* ${parseFloat(data.pyrano || 0).toFixed(0)} –í—Ç/–º¬≤\n\nüïí *–û–±–Ω–æ–≤–ª–µ–Ω–æ:* ${new Date(data.timestamp_iso).toLocaleString('ru-RU')}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüü¢ - –ù–æ—Ä–º–∞  üü° - –í–Ω–∏–º–∞–Ω–∏–µ  üî¥ - –ö—Ä–∏—Ç–∏—á–Ω–æ\n\n‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /status –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è`;\n\nreturn [{\n  json: {\n    chatId: chatId,\n    message: message\n  }\n}];"
      },
      "id": "format-status",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      },
      "id": "send-telegram",
      "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1120, 200],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.\\n\\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\\n/status - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–µ–ø–ª–∏—Ü—ã\\n/—Å—Ç–∞—Ç—É—Å - –¢–æ –∂–µ —Å–∞–º–æ–µ",
        "additionalFields": {}
      },
      "id": "send-unknown",
      "name": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [680, 400],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–æ–º–∞–Ω–¥—ã",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–æ–º–∞–Ω–¥—ã": {
      "main": [
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-18T00:00:00.000Z",
  "versionId": "1"
}
