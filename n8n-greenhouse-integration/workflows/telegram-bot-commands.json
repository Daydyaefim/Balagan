{
  "name": "Telegram Bot - Commands",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ]
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        240,
        400
      ],
      "webhookId": "telegram-ugagro-bot",
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "mode": "rules",
        "rules": {
          "rules": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "id": "status-1",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/status",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "status-2",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/—Å—Ç–∞—Ç—É—Å",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "or"
              },
              "renameOutput": true,
              "outputKey": "status"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false
                },
                "conditions": [
                  {
                    "id": "poliv-1",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/poliv",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "poliv-2",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/–ø–æ–ª–∏–≤",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "or"
              },
              "renameOutput": true,
              "outputKey": "poliv"
            }
          ]
        },
        "options": {}
      },
      "id": "route-command",
      "name": "–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ö–æ–º–∞–Ω–¥",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        460,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ugagro_readings\nORDER BY timestamp DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-latest-data-status",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–°—Ç–∞—Ç—É—Å)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        680,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst chatId = $node[\"Telegram Trigger\"].json.message.chat.id;\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —á–∏—Å–ª–∞\nconst temp = parseFloat(data.temperature) || 0;\nconst hum = parseFloat(data.humidity) || 0;\nconst water = parseFloat(data.water_level) || 0;\nconst outdoorTemp = parseFloat(data.outdoor_temperature) || null;\nconst pyrano = parseFloat(data.pyrano) || 0;\nconst windowPos = parseInt(data.window_position) || 0;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\nconst message = `üå± *–ü–û–ö–ê–ó–ê–ù–ò–Ø UGAGRO 95*\n\nüå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ø–ª–∏—Ü—ã:* ${temp.toFixed(1)}¬∞C\nüíß *–í–ª–∞–∂–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–∏—Ü—ã:* ${hum.toFixed(1)}%\nüå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —É–ª–∏—Ü—ã:* ${outdoorTemp ? outdoorTemp.toFixed(1) + '¬∞C' : '–Ω/–¥'}\nüí¶ *–£—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Ç–≤–æ—Ä–∞:* ${water.toFixed(1)}%\n‚òÄÔ∏è *–¢–µ–∫—É—â–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${pyrano.toFixed(0)} –í—Ç/–º¬≤\nü™ü *–ü–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–æ—Ä—Ç–æ—á–∫–∏:* ${windowPos}%\nüïí *–í—Ä–µ–º—è ESP32:* ${new Date(data.timestamp_iso).toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚ÑπÔ∏è /poliv - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–∏–≤–µ`;\n\nreturn [{\n  json: {\n    chatId: chatId,\n    message: message\n  }\n}];"
      },
      "id": "format-status",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT r.*, w.* FROM ugagro_readings r\nCROSS JOIN watering_settings w\nORDER BY r.timestamp DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-latest-data-poliv",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–ü–æ–ª–∏–≤)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        680,
        500
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst chatId = $node[\"Telegram Trigger\"].json.message.chat.id;\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ\nconst wateringMode = parseInt(data.watering_mode) || 0;\nconst pyrano = parseFloat(data.pyrano) || 0;\nconst radSum = parseFloat(data.rad_sum) || 0;\nconst wateringDuration = parseInt(data.watering_duration_sec) || 60;\nconst radThreshold = parseFloat(data.rad_threshold) || 500;\nconst maxInterval = parseInt(data.max_interval_minutes) || 180;\nconst lastWateringUnix = parseInt(data.last_watering_start_unix) || 0;\nconst cycleCount = parseInt(data.cycle_count) || 0;\nconst forceActive = data.force_watering_active || false;\n\n// –û–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤\nconst windowStart = data.watering_window_start || '08:00:00';\nconst windowEnd = data.watering_window_end || '20:00:00';\n\n// –ù–∞–∑–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤\nconst modeNames = {\n  0: '‚öôÔ∏è –†—É—á–Ω–æ–π (–ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É)',\n  1: 'üåÖ –£—Ç—Ä–µ–Ω–Ω–∏–π',\n  2: '‚òÄÔ∏è –ü–æ —Ä–∞–¥–∏–∞—Ü–∏–∏',\n  3: 'üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π'\n};\n\nconst modeName = modeNames[wateringMode] || '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';\n\n// –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–∏–≤–∞\nlet nextWateringInfo = '';\nconst now = Math.floor(Date.now() / 1000);\nconst timeSinceLastWatering = lastWateringUnix > 0 ? now - lastWateringUnix : 0;\nconst minutesSinceLast = Math.floor(timeSinceLastWatering / 60);\n\n// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ú–æ—Å–∫–≤—ã\nconst moscowTime = new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', hour12: false });\nconst currentHour = new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', hour: 'numeric', hour12: false });\nconst currentMinute = new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', minute: 'numeric' });\nconst currentTime = `${currentHour.padStart(2, '0')}:${currentMinute.padStart(2, '0')}`;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –≤ –æ–∫–Ω–µ –ø–æ–ª–∏–≤–æ–≤\nconst isInWindow = currentTime >= windowStart && currentTime <= windowEnd;\n\nif (wateringMode === 0) {\n  // –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º - –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É\n  const manualInterval = parseInt(data.manual_interval_minutes) || 60;\n  const minutesUntilNext = manualInterval - minutesSinceLast;\n  \n  if (minutesUntilNext > 0 && minutesUntilNext <= maxInterval) {\n    const hours = Math.floor(minutesUntilNext / 60);\n    const mins = minutesUntilNext % 60;\n    nextWateringInfo = hours > 0 ? `—á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω` : `—á–µ—Ä–µ–∑ ${mins}–º–∏–Ω`;\n  } else if (minutesUntilNext > maxInterval) {\n    nextWateringInfo = `–º–∞–∫—Å. —á–µ—Ä–µ–∑ ${Math.floor(maxInterval / 60)}—á ${maxInterval % 60}–º–∏–Ω`;\n  } else {\n    nextWateringInfo = '—Å–∫–æ—Ä–æ';\n  }\n} else if (wateringMode === 1) {\n  // –£—Ç—Ä–µ–Ω–Ω–∏–π —Ä–µ–∂–∏–º\n  const morningCount = parseInt(data.morning_count) || 3;\n  nextWateringInfo = cycleCount >= morningCount ? '–∑–∞–≤—Ç—Ä–∞ —É—Ç—Ä–æ–º' : '–ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é —É—Ç—Ä–æ–º';\n} else if (wateringMode === 2) {\n  // –ü–æ —Ä–∞–¥–∏–∞—Ü–∏–∏\n  const radNeeded = radThreshold - radSum;\n  \n  if (radNeeded <= 0) {\n    nextWateringInfo = '–≥–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É';\n  } else if (pyrano > 0) {\n    // –ü—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞—Å—á–µ—Ç (–æ—á–µ–Ω—å –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π)\n    const minutesNeeded = Math.floor(radNeeded / pyrano * 60);\n    \n    if (minutesNeeded <= maxInterval) {\n      const hours = Math.floor(minutesNeeded / 60);\n      const mins = minutesNeeded % 60;\n      nextWateringInfo = hours > 0 ? `~—á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω` : `~—á–µ—Ä–µ–∑ ${mins}–º–∏–Ω`;\n    } else {\n      nextWateringInfo = `>–º–∞–∫—Å. –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ (${Math.floor(maxInterval / 60)}—á)`;\n    }\n  } else {\n    nextWateringInfo = '–æ–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ª–Ω—Ü–∞';\n  }\n} else if (wateringMode === 3) {\n  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π\n  nextWateringInfo = forceActive ? '–∏–¥–µ—Ç —Å–µ–π—á–∞—Å' : '–ø–æ –∫–æ–º–∞–Ω–¥–µ';\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–∏–≤–∞\nif (!isInWindow && wateringMode !== 3) {\n  nextWateringInfo = '–∑–∞–≤—Ç—Ä–∞ (–≤–Ω–µ –æ–∫–Ω–∞ –ø–æ–ª–∏–≤–æ–≤)';\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\nconst message = `üíß *–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–ò–í–ï*\n\n‚öôÔ∏è *–†–µ–∂–∏–º:* ${modeName}\n‚òÄÔ∏è *–¢–µ–∫—É—â–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${pyrano.toFixed(0)} –í—Ç/–º¬≤\nüìä *–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${radSum.toFixed(1)} –í—Ç/–º¬≤\nüéØ *–ü–æ—Ä–æ–≥ —Ä–∞–¥–∏–∞—Ü–∏–∏:* ${radThreshold.toFixed(0)} –í—Ç/–º¬≤ (–¥–ª—è —Ä–µ–∂–∏–º–∞ 2)\n‚è±Ô∏è *–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞:* ${wateringDuration} —Å–µ–∫\nüîÑ *–¶–∏–∫–ª–æ–≤ –ø–æ–ª–∏–≤–∞ —Å–µ–≥–æ–¥–Ω—è:* ${cycleCount}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚è∞ *–°–õ–ï–î–£–Æ–©–ò–ô –ü–û–õ–ò–í:*\n${nextWateringInfo}\n\n‚è≥ *–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:* ${Math.floor(maxInterval / 60)}—á ${maxInterval % 60}–º–∏–Ω\nüïê *–û–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤:* ${windowStart.substring(0, 5)} - ${windowEnd.substring(0, 5)}\n${isInWindow ? '‚úÖ –°–µ–π—á–∞—Å –≤ –æ–∫–Ω–µ –ø–æ–ª–∏–≤–æ–≤' : '‚è∏Ô∏è –í–Ω–µ –æ–∫–Ω–∞ –ø–æ–ª–∏–≤–æ–≤'}\n\n${lastWateringUnix > 0 ? `üïí *–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤:* ${new Date(lastWateringUnix * 1000).toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}` : ''}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n‚ÑπÔ∏è /status - –ø–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞—Ç—á–∏–∫–æ–≤`;\n\nreturn [{\n  json: {\n    chatId: chatId,\n    message: message\n  }\n}];"
      },
      "id": "format-poliv",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ü–æ–ª–∏–≤",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      },
      "id": "send-telegram",
      "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1120,
        300
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.\\n\\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\\n/status - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–µ–ø–ª–∏—Ü—ã\\n/poliv - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–∏–≤–µ",
        "additionalFields": {}
      },
      "id": "send-unknown",
      "name": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        680,
        600
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ö–æ–º–∞–Ω–¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ö–æ–º–∞–Ω–¥": {
      "main": [
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–°—Ç–∞—Ç—É—Å)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–ü–æ–ª–∏–≤)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–°—Ç–∞—Ç—É—Å)": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–ü–æ–ª–∏–≤)": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ü–æ–ª–∏–≤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ü–æ–ª–∏–≤": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-19T00:00:00.000Z",
  "versionId": "5"
}
