{
  "name": "Telegram Bot - Commands",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -400,
        608
      ],
      "webhookId": "telegram-ugagro-bot",
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "/status",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "/—Å—Ç–∞—Ç—É—Å",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "check-status",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ /status",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -160,
        512
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "/poliv",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "/–ø–æ–ª–∏–≤",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "check-poliv",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ /poliv",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -160,
        704
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ugagro_readings\nORDER BY timestamp DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-latest-data-status",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–°—Ç–∞—Ç—É—Å)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        48,
        400
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst chatId = $node[\"Telegram Trigger\"].json.message.chat.id;\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —á–∏—Å–ª–∞\nconst temp = parseFloat(data.temperature) || 0;\nconst hum = parseFloat(data.humidity) || 0;\nconst water = parseFloat(data.water_level) || 0;\nconst outdoorTemp = parseFloat(data.outdoor_temperature) || null;\nconst pyrano = parseFloat(data.pyrano) || 0;\nconst windowPos = parseInt(data.window_position) || 0;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\nconst message = `üå± *–ü–û–ö–ê–ó–ê–ù–ò–Ø UGAGRO 95*\n\nüå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ø–ª–∏—Ü—ã:* ${temp.toFixed(1)}¬∞C\nüíß *–í–ª–∞–∂–Ω–æ—Å—Ç—å —Ç–µ–ø–ª–∏—Ü—ã:* ${hum.toFixed(1)}%\nüå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —É–ª–∏—Ü—ã:* ${outdoorTemp ? outdoorTemp.toFixed(1) + '¬∞C' : '–Ω/–¥'}\nüí¶ *–£—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Ç–≤–æ—Ä–∞:* ${water.toFixed(1)}%\n‚òÄÔ∏è *–¢–µ–∫—É—â–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${pyrano.toFixed(0)} –í—Ç/–º¬≤\nü™ü *–ü–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–æ—Ä—Ç–æ—á–∫–∏:* ${windowPos}%\nüïí *–í—Ä–µ–º—è ESP32:* ${new Date(data.timestamp_iso).toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}`;\n\nreturn [{\n  json: {\n    chatId: chatId,\n    message: message\n  }\n}];"
      },
      "id": "format-status",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT r.*, w.* FROM ugagro_readings r\nCROSS JOIN watering_settings w\nORDER BY r.timestamp DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-latest-data-poliv",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–ü–æ–ª–∏–≤)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        48,
        608
      ],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst chatId = $node[\"Telegram Trigger\"].json.message.chat.id;\n\n// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ\nconst wateringMode = parseInt(data.watering_mode) || 0;\nconst pyrano = parseFloat(data.pyrano) || 0;\nconst radSum = parseFloat(data.rad_sum) || 0;\nconst wateringDuration = parseInt(data.watering_duration_sec) || 200;\nconst radThreshold = parseFloat(data.rad_threshold) || 1.1;\nconst maxInterval = parseInt(data.max_interval_minutes) || 90;\nconst lastWateringUnix = parseInt(data.last_watering_start_unix) || 0;\nconst cycleCount = parseInt(data.cycle_count) || 0;\nconst forceActive = data.force_watering_active || false;\n\n// –û–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤\nconst windowStart = data.watering_window_start || '07:40:00';\nconst windowEnd = data.watering_window_end || '17:20:00';\n\n// –ù–∞–∑–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ (0=–ê–≤—Ç–æ, 1=–†—É—á–Ω–æ–π, 2=–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π)\nconst modeNames = {\n  0: 'ü§ñ –ê–≤—Ç–æ',\n  1: '‚öôÔ∏è –†—É—á–Ω–æ–π',\n  2: 'üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π'\n};\n\nconst modeName = modeNames[wateringMode] || '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';\n\n// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º radSum –∏–∑ J/m¬≤ –≤ MJ/m¬≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\nconst radSumMJ = radSum / 1000000;\n\n// –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–∏–≤–∞\nlet nextWateringInfo = '';\nconst now = Math.floor(Date.now() / 1000);\nconst timeSinceLastWatering = lastWateringUnix > 0 ? now - lastWateringUnix : 0;\nconst minutesSinceLast = Math.floor(timeSinceLastWatering / 60);\n\n// –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ –ú–æ—Å–∫–≤—ã\nconst currentHour = parseInt(new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', hour: 'numeric', hour12: false }));\nconst currentMinute = parseInt(new Date().toLocaleString('ru-RU', { timeZone: 'Europe/Moscow', minute: 'numeric' }));\nconst currentMin = currentHour * 60 + currentMinute;\n\n// –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –æ–∫–Ω–∞ –ø–æ–ª–∏–≤–æ–≤\nconst [startH, startM] = windowStart.split(':').map(Number);\nconst [endH, endM] = windowEnd.split(':').map(Number);\nconst startMin = startH * 60 + startM;\nconst endMin = endH * 60 + endM;\nconst isInWindow = currentMin >= startMin && currentMin < endMin;\n\nif (wateringMode === 0) {\n  // –ê–≤—Ç–æ —Ä–µ–∂–∏–º - –ø–æ —Ä–∞–¥–∏–∞—Ü–∏–∏ —Å —É—á–µ—Ç–æ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞\n  const radNeeded = (radThreshold * 1000000) - radSum; // radThreshold –≤ MJ, radSum –≤ J\n  \n  if (radNeeded <= 0) {\n    nextWateringInfo = '—Å–∫–æ—Ä–æ (—Ä–∞–¥–∏–∞—Ü–∏—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∞)';\n  } else if (pyrano > 0) {\n    // –†–∞—Å—á–µ—Ç –ø–æ —Ä–∞–¥–∏–∞—Ü–∏–∏\n    const secondsNeeded = Math.floor(radNeeded / pyrano);\n    const minutesNeeded = Math.floor(secondsNeeded / 60);\n    \n    if (minutesNeeded <= maxInterval) {\n      const hours = Math.floor(minutesNeeded / 60);\n      const mins = minutesNeeded % 60;\n      nextWateringInfo = hours > 0 ? `~—á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω` : `~—á–µ—Ä–µ–∑ ${mins}–º–∏–Ω`;\n    } else {\n      nextWateringInfo = `–º–∞–∫—Å. —á–µ—Ä–µ–∑ ${Math.floor(maxInterval / 60)}—á ${maxInterval % 60}–º–∏–Ω`;\n    }\n  } else {\n    // –ù–µ—Ç —Å–æ–ª–Ω—Ü–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∞–∫—Å. –∏–Ω—Ç–µ—Ä–≤–∞–ª\n    const minutesUntilMax = maxInterval - minutesSinceLast;\n    if (minutesUntilMax > 0) {\n      const hours = Math.floor(minutesUntilMax / 60);\n      const mins = minutesUntilMax % 60;\n      nextWateringInfo = hours > 0 ? `—á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω (–º–∞–∫—Å. –∏–Ω—Ç–µ—Ä–≤–∞–ª)` : `—á–µ—Ä–µ–∑ ${mins}–º–∏–Ω`;\n    } else {\n      nextWateringInfo = '—Å–∫–æ—Ä–æ (–º–∞–∫—Å. –∏–Ω—Ç–µ—Ä–≤–∞–ª)';\n    }\n  }\n} else if (wateringMode === 1) {\n  // –†—É—á–Ω–æ–π —Ä–µ–∂–∏–º - –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É\n  const manualInterval = parseInt(data.manual_interval_minutes) || 60;\n  const minutesUntilNext = manualInterval - minutesSinceLast;\n  \n  if (minutesUntilNext > 0) {\n    const hours = Math.floor(minutesUntilNext / 60);\n    const mins = minutesUntilNext % 60;\n    nextWateringInfo = hours > 0 ? `—á–µ—Ä–µ–∑ ${hours}—á ${mins}–º–∏–Ω` : `—á–µ—Ä–µ–∑ ${mins}–º–∏–Ω`;\n  } else {\n    nextWateringInfo = '—Å–∫–æ—Ä–æ';\n  }\n} else if (wateringMode === 2) {\n  // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º\n  nextWateringInfo = forceActive ? '–∏–¥–µ—Ç —Å–µ–π—á–∞—Å' : '–ø–æ –∫–æ–º–∞–Ω–¥–µ';\n}\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–ª–∏–≤–∞ (–∫—Ä–æ–º–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ)\nif (!isInWindow && wateringMode !== 2) {\n  nextWateringInfo = '–≤–Ω–µ –æ–∫–Ω–∞ –ø–æ–ª–∏–≤–æ–≤';\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ\nconst message = `üíß *–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–ò–í–ï*\n\n‚öôÔ∏è *–†–µ–∂–∏–º:* ${modeName}\n‚òÄÔ∏è *–¢–µ–∫—É—â–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${pyrano.toFixed(0)} –í—Ç/–º¬≤\nüìä *–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${radSumMJ.toFixed(2)} –ú–î–∂/–º¬≤\nüéØ *–ü–æ—Ä–æ–≥ —Ä–∞–¥–∏–∞—Ü–∏–∏:* ${radThreshold.toFixed(1)} –ú–î–∂/–º¬≤\n‚è±Ô∏è *–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞:* ${wateringDuration} —Å–µ–∫\nüîÑ *–¶–∏–∫–ª–æ–≤ –ø–æ–ª–∏–≤–∞ —Å–µ–≥–æ–¥–Ω—è:* ${cycleCount}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n‚è∞ *–°–õ–ï–î–£–Æ–©–ò–ô –ü–û–õ–ò–í:*\n${nextWateringInfo}\n\n‚è≥ *–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:* ${Math.floor(maxInterval / 60)}—á ${maxInterval % 60}–º–∏–Ω\nüïê *–û–∫–Ω–æ –ø–æ–ª–∏–≤–æ–≤:* ${windowStart.substring(0, 5)} - ${windowEnd.substring(0, 5)}\n\n${lastWateringUnix > 0 ? `üïí *–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–∏–≤:* ${new Date(lastWateringUnix * 1000).toLocaleString('ru-RU', { timeZone: 'Europe/Moscow' })}` : ''}`;\n\nreturn [{\n  json: {\n    chatId: chatId,\n    message: message\n  }\n}];"
      },
      "id": "format-poliv",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ü–æ–ª–∏–≤",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        272,
        608
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      },
      "id": "send-telegram",
      "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        496,
        512
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.\\n\\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\\n/status - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–µ–ø–ª–∏—Ü—ã\\n/poliv - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª–∏–≤–µ",
        "additionalFields": {}
      },
      "id": "send-unknown",
      "name": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        48,
        800
      ],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∫–∞ /status",
            "type": "main",
            "index": 0
          },
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∫–∞ /poliv",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ /status": {
      "main": [
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–°—Ç–∞—Ç—É—Å)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ö–æ–º–∞–Ω–¥–∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ /poliv": {
      "main": [
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–ü–æ–ª–∏–≤)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–°—Ç–∞—Ç—É—Å)": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –î–∞–Ω–Ω—ã–µ (–ü–æ–ª–∏–≤)": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ü–æ–ª–∏–≤",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –°—Ç–∞—Ç—É—Å": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ü–æ–ª–∏–≤": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-19T00:00:00.000Z",
  "versionId": "6"
}
