{
  "name": "02 - Critical Alerts Monitor",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 20
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger (20 —Å–µ–∫)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "read",
        "filePath": "/data/ugagro_readings.json",
        "options": {}
      },
      "id": "read-latest",
      "name": "–ß–∏—Ç–∞—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "read",
        "filePath": "/data/telegram_alert_states.json",
        "options": {}
      },
      "id": "read-alert-states",
      "name": "–ß–∏—Ç–∞—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏—è –û–ø–æ–≤–µ—â–µ–Ω–∏–π",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [650, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ä–æ–≥–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π\nconst dbData = $node[\"–ß–∏—Ç–∞—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ\"].json.data;\nconst readings = typeof dbData === 'string' ? JSON.parse(dbData) : dbData;\n\nif (!readings || readings.length === 0) {\n  return [];\n}\n\nconst latest = readings[readings.length - 1];\n\n// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–ø–æ–≤–µ—â–µ–Ω–∏–π\nlet alertStates = {};\ntry {\n  const statesData = $node[\"–ß–∏—Ç–∞—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏—è –û–ø–æ–≤–µ—â–µ–Ω–∏–π\"].json.data;\n  if (statesData) {\n    alertStates = typeof statesData === 'string' ? JSON.parse(statesData) : statesData;\n  }\n} catch (e) {\n  alertStates = {\n    temperature: { acknowledged: false, lastAlert: null },\n    humidity: { acknowledged: false, lastAlert: null },\n    water_level: { acknowledged: false, lastAlert: null },\n    wind_speed: { acknowledged: false, lastAlert: null }\n  };\n}\n\n// –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Ä–æ–≥–∏\nconst thresholds = {\n  temperature: { min: 10, max: 40 },\n  humidity: { min: 20, max: 85 },\n  water_level: { min: 5 },\n  wind_speed: { max: 11 }\n};\n\nconst alerts = [];\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã\nif (latest.temperature < thresholds.temperature.min || latest.temperature > thresholds.temperature.max) {\n  if (!alertStates.temperature.acknowledged) {\n    alerts.push({\n      type: 'temperature',\n      value: latest.temperature,\n      message: `‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –¢–ï–ú–ü–ï–†–ê–¢–£–†–ê\\n\\nüå°Ô∏è –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${latest.temperature.toFixed(1)}¬∞C\\nüìä –ù–æ—Ä–º–∞: ${thresholds.temperature.min}-${thresholds.temperature.max}¬∞C\\n‚è∞ –í—Ä–µ–º—è: ${latest.timestamp_iso}`,\n      severity: 'critical'\n    });\n  }\n} else {\n  // –°–±—Ä–æ—Å–∏—Ç—å acknowledged –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–æ—Å—å –≤ –Ω–æ—Ä–º—É\n  alertStates.temperature.acknowledged = false;\n}\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–∂–Ω–æ—Å—Ç–∏\nif (latest.humidity < thresholds.humidity.min || latest.humidity > thresholds.humidity.max) {\n  if (!alertStates.humidity.acknowledged) {\n    alerts.push({\n      type: 'humidity',\n      value: latest.humidity,\n      message: `‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –í–õ–ê–ñ–ù–û–°–¢–¨\\n\\nüíß –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${latest.humidity.toFixed(1)}%\\nüìä –ù–æ—Ä–º–∞: ${thresholds.humidity.min}-${thresholds.humidity.max}%\\n‚è∞ –í—Ä–µ–º—è: ${latest.timestamp_iso}`,\n      severity: 'critical'\n    });\n  }\n} else {\n  alertStates.humidity.acknowledged = false;\n}\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –≤–æ–¥—ã\nif (latest.water_level < thresholds.water_level.min) {\n  if (!alertStates.water_level.acknowledged) {\n    alerts.push({\n      type: 'water_level',\n      value: latest.water_level,\n      message: `üíß –ù–ò–ó–ö–ò–ô –£–†–û–í–ï–ù–¨ –í–û–î–´\\n\\nüìâ –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${latest.water_level.toFixed(1)}%\\n‚ö†Ô∏è –ú–∏–Ω–∏–º—É–º: ${thresholds.water_level.min}%\\n‚è∞ –í—Ä–µ–º—è: ${latest.timestamp_iso}`,\n      severity: 'warning'\n    });\n  }\n} else {\n  alertStates.water_level.acknowledged = false;\n}\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–µ—Ç—Ä–∞\nif (latest.wind_speed > thresholds.wind_speed.max) {\n  if (!alertStates.wind_speed.acknowledged) {\n    alerts.push({\n      type: 'wind_speed',\n      value: latest.wind_speed,\n      message: `üí® –°–ò–õ–¨–ù–´–ô –í–ï–¢–ï–†\\n\\nüå™Ô∏è –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${latest.wind_speed.toFixed(1)} –º/—Å\\n‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º: ${thresholds.wind_speed.max} –º/—Å\\n‚è∞ –í—Ä–µ–º—è: ${latest.timestamp_iso}`,\n      severity: 'warning'\n    });\n  }\n} else {\n  alertStates.wind_speed.acknowledged = false;\n}\n\n// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\nreturn alerts.map(alert => ({\n  json: {\n    alert,\n    alertStates,\n    latestReading: latest\n  }\n}));"
      },
      "id": "check-thresholds",
      "name": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ü–æ—Ä–æ–≥–∏",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.alert ? 1 : 0 }}",
              "value2": 1
            }
          ]
        }
      },
      "id": "if-alerts",
      "name": "–ï—Å—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
        "text": "={{ $json.alert.message }}",
        "additionalFields": {
          "reply_markup": {
            "inline_keyboard": [
              [
                {
                  "text": "‚úÖ –ü—Ä–∏–Ω—è—Ç–æ –∫ —Å–≤–µ–¥–µ–Ω–∏—é",
                  "callback_data": "ack_{{ $json.alert.type }}"
                }
              ]
            ]
          }
        }
      },
      "id": "send-telegram",
      "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1250, 200],
      "credentials": {
        "telegramApi": {
          "id": "2",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "write",
        "filePath": "/data/ugagro_alerts_history.json",
        "fileContent": "={{ JSON.stringify($json, null, 2) }}",
        "options": {
          "append": true
        }
      },
      "id": "save-alert-history",
      "name": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ò—Å—Ç–æ—Ä–∏—é",
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [1450, 200]
    }
  ],
  "connections": {
    "Schedule Trigger (20 —Å–µ–∫)": {
      "main": [
        [
          {
            "node": "–ß–∏—Ç–∞—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ß–∏—Ç–∞—Ç—å –ü–æ—Å–ª–µ–¥–Ω–∏–µ –î–∞–Ω–Ω—ã–µ": {
      "main": [
        [
          {
            "node": "–ß–∏—Ç–∞—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏—è –û–ø–æ–≤–µ—â–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ß–∏—Ç–∞—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏—è –û–ø–æ–≤–µ—â–µ–Ω–∏–π": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ü–æ—Ä–æ–≥–∏",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ü–æ—Ä–æ–≥–∏": {
      "main": [
        [
          {
            "node": "–ï—Å—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ï—Å—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏—è?": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram": {
      "main": [
        [
          {
            "node": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ò—Å—Ç–æ—Ä–∏—é",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-01-18T00:00:00.000Z",
  "versionId": "1"
}
