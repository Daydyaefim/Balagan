{
  "name": "Telegram - Watering Notifications",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 30
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Schedule Every 30 Seconds",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM ugagro_readings\nORDER BY timestamp DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-latest-reading",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ü–æ–∫–∞–∑–∞–Ω–∏–µ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [460, 300],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM watering_notifications\nORDER BY id DESC\nLIMIT 1;",
        "options": {}
      },
      "id": "get-notification-state",
      "name": "–ü–æ–ª—É—á–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏–µ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [680, 300],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const reading = $node[\"–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ü–æ–∫–∞–∑–∞–Ω–∏–µ\"].json;\nconst notification = $input.first().json;\n\n// –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞—Å–æ—Å–∞\nconst currentPumpState = reading.pump_state || false;\nconst lastPumpState = notification.last_pump_state || false;\n\n// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è\nlet notificationType = null;\nlet shouldNotify = false;\n\nif (currentPumpState && !lastPumpState) {\n  // –ù–∞—Å–æ—Å –≤–∫–ª—é—á–∏–ª—Å—è - –Ω–∞—á–∞–ª–æ –ø–æ–ª–∏–≤–∞\n  notificationType = 'start';\n  shouldNotify = true;\n} else if (!currentPumpState && lastPumpState) {\n  // –ù–∞—Å–æ—Å –≤—ã–∫–ª—é—á–∏–ª—Å—è - –∫–æ–Ω–µ—Ü –ø–æ–ª–∏–≤–∞\n  notificationType = 'end';\n  shouldNotify = true;\n}\n\nif (!shouldNotify) {\n  // –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º\n  return [];\n}\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\nreturn [{\n  json: {\n    notification_type: notificationType,\n    current_pump_state: currentPumpState,\n    last_pump_state: lastPumpState,\n    temperature: parseFloat(reading.temperature) || 0,\n    humidity: parseFloat(reading.humidity) || 0,\n    pyrano: parseFloat(reading.pyrano) || 0,\n    rad_sum: parseFloat(reading.rad_sum) || 0,\n    cycle_count: parseInt(reading.cycle_count) || 0,\n    watering_mode: parseInt(reading.watering_mode) || 0,\n    timestamp: reading.timestamp_iso\n  }\n}];"
      },
      "id": "check-pump-state-change",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ò–∑–º–µ–Ω–µ–Ω–∏—è –°–æ—Å—Ç–æ—è–Ω–∏—è",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.notification_type }}",
              "rightValue": "start",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-notification-type",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–∏–ø–∞ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\n\n// –ù–∞–∑–≤–∞–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ (0=–ê–≤—Ç–æ, 1=–†—É—á–Ω–æ–π, 2=–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π)\nconst modeNames = {\n  0: '–ê–≤—Ç–æ',\n  1: '–†—É—á–Ω–æ–π',\n  2: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π'\n};\n\nconst modeName = modeNames[data.watering_mode] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';\n\n// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º radSum –∏–∑ J/m¬≤ –≤ MJ/m¬≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\nconst radSumMJ = (data.rad_sum || 0) / 1000000;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø–æ–ª–∏–≤–∞\nconst message = `üíß *–ü–û–õ–ò–í –ù–ê–ß–ê–õ–°–Ø*\n\n‚öôÔ∏è *–†–µ–∂–∏–º:* ${modeName}\n‚òÄÔ∏è *–†–∞–¥–∏–∞—Ü–∏—è:* ${data.pyrano.toFixed(0)} –í—Ç/–º¬≤\nüìä *–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${radSumMJ.toFixed(2)} –ú–î–∂/–º¬≤\nüîÑ *–¶–∏–∫–ª –ø–æ–ª–∏–≤–∞:* ${data.cycle_count}\n\nüå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:* ${data.temperature.toFixed(1)}¬∞C\nüíß *–í–ª–∞–∂–Ω–æ—Å—Ç—å:* ${data.humidity.toFixed(1)}%\n\nüïí *–í—Ä–µ–º—è:* ${new Date(data.timestamp * 1000).toLocaleString('ru-RU')}`;\n\nreturn [{\n  json: {\n    ...data,\n    message: message\n  }\n}];"
      },
      "id": "format-start-notification",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ù–∞—á–∞–ª–æ –ü–æ–ª–∏–≤–∞",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\nconst lastWateringStart = $node[\"–ü–æ–ª—É—á–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏–µ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\"].json.last_watering_start;\n\n// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏–≤–∞\nlet durationInfo = '';\nif (lastWateringStart) {\n  const startTime = new Date(lastWateringStart).getTime();\n  const endTime = new Date(data.timestamp).getTime();\n  const durationSec = Math.floor((endTime - startTime) / 1000);\n  \n  const minutes = Math.floor(durationSec / 60);\n  const seconds = durationSec % 60;\n  \n  durationInfo = `‚è±Ô∏è *–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:* ${minutes > 0 ? minutes + '–º–∏–Ω ' : ''}${seconds}—Å–µ–∫`;\n}\n\n// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º radSum –∏–∑ J/m¬≤ –≤ MJ/m¬≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è\nconst radSumMJ = (data.rad_sum || 0) / 1000000;\n\n// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∫–æ–Ω—Ü–µ –ø–æ–ª–∏–≤–∞\nconst message = `‚úÖ *–ü–û–õ–ò–í –ó–ê–í–ï–†–®–ï–ù*\n\n${durationInfo}\n\nüå°Ô∏è *–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:* ${data.temperature.toFixed(1)}¬∞C\nüíß *–í–ª–∞–∂–Ω–æ—Å—Ç—å:* ${data.humidity.toFixed(1)}%\n‚òÄÔ∏è *–†–∞–¥–∏–∞—Ü–∏—è:* ${data.pyrano.toFixed(0)} –í—Ç/–º¬≤\nüìä *–ù–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è —Ä–∞–¥–∏–∞—Ü–∏—è:* ${radSumMJ.toFixed(2)} –ú–î–∂/–º¬≤\n\nüïí *–í—Ä–µ–º—è:* ${new Date(data.timestamp * 1000).toLocaleString('ru-RU')}`;\n\nreturn [{\n  json: {\n    ...data,\n    message: message,\n    duration_sec: lastWateringStart ? Math.floor((new Date(data.timestamp).getTime() - new Date(lastWateringStart).getTime()) / 1000) : 0\n  }\n}];"
      },
      "id": "format-end-notification",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–æ–Ω–µ—Ü –ü–æ–ª–∏–≤–∞",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "chatId": "–£–ö–ê–ñ–ò–¢–ï_–í–ê–®_TELEGRAM_CHAT_ID",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      },
      "id": "send-telegram-notification",
      "name": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1560, 300],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\nconst notificationType = data.notification_type;\n\nlet sqlQuery = '';\n\nif (notificationType === 'start') {\n  // –ù–∞—á–∞–ª–æ –ø–æ–ª–∏–≤–∞\n  sqlQuery = `\nUPDATE watering_notifications SET\n  last_pump_state = true,\n  last_check_timestamp = NOW(),\n  last_notification_type = 'start',\n  last_notification_sent_at = NOW(),\n  notifications_count = notifications_count + 1,\n  last_watering_start = NOW(),\n  updated_at = NOW()\nWHERE id = 1;\n`;\n} else if (notificationType === 'end') {\n  // –ö–æ–Ω–µ—Ü –ø–æ–ª–∏–≤–∞\n  const durationSec = data.duration_sec || 0;\n  \n  sqlQuery = `\nUPDATE watering_notifications SET\n  last_pump_state = false,\n  last_check_timestamp = NOW(),\n  last_notification_type = 'end',\n  last_notification_sent_at = NOW(),\n  notifications_count = notifications_count + 1,\n  last_watering_end = NOW(),\n  last_watering_duration_sec = ${durationSec},\n  updated_at = NOW()\nWHERE id = 1;\n`;\n}\n\nreturn [{ json: { sql_query: sqlQuery } }];"
      },
      "id": "prepare-update-sql",
      "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û–±–Ω–æ–≤–ª–µ–Ω–∏—è",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sql_query }}",
        "options": {}
      },
      "id": "update-notification-state",
      "name": "–û–±–Ω–æ–≤–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏–µ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [2000, 300],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    }
  ],
  "connections": {
    "Schedule Every 30 Seconds": {
      "main": [
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ü–æ–∫–∞–∑–∞–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –ü–æ—Å–ª–µ–¥–Ω–µ–µ –ü–æ–∫–∞–∑–∞–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–ü–æ–ª—É—á–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏–µ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–ª—É—á–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏–µ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ò–∑–º–µ–Ω–µ–Ω–∏—è –°–æ—Å—Ç–æ—è–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ò–∑–º–µ–Ω–µ–Ω–∏—è –°–æ—Å—Ç–æ—è–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–∏–ø–∞ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¢–∏–ø–∞ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ù–∞—á–∞–ª–æ –ü–æ–ª–∏–≤–∞",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–æ–Ω–µ—Ü –ü–æ–ª–∏–≤–∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ù–∞—á–∞–ª–æ –ü–æ–ª–∏–≤–∞": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ö–æ–Ω–µ—Ü –ü–æ–ª–∏–≤–∞": {
      "main": [
        [
          {
            "node": "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û–±–Ω–æ–≤–ª–µ–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û–±–Ω–æ–≤–ª–µ–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–û–±–Ω–æ–≤–∏—Ç—å –°–æ—Å—Ç–æ—è–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-19T00:00:00.000Z",
  "versionId": "1"
}
