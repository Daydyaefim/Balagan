{
  "name": "Telegram - Callback Handler",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "callback_query"
        ]
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [240, 300],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–∞—Ä—Å–∏–Ω–≥ callback data –æ—Ç –∫–Ω–æ–ø–æ–∫\nconst callback = $input.first().json;\n\nif (!callback || !callback.callback_query || !callback.callback_query.data) {\n  throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ callback');\n}\n\nconst callbackData = callback.callback_query.data;\nconst chatId = callback.callback_query.message.chat.id;\nconst messageId = callback.callback_query.message.message_id;\n\n// –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ: \"ack_high_temperature\" –∏–ª–∏ \"mute_low_humidity_1h\"\nconst parts = callbackData.split('_');\nconst action = parts[0]; // 'ack' –∏–ª–∏ 'mute'\n\nlet alertType;\nlet muteDuration = null;\n\nif (action === 'ack') {\n  // ack_high_temperature\n  alertType = parts.slice(1).join('_');\n} else if (action === 'mute') {\n  // mute_low_humidity_1h\n  const durationStr = parts[parts.length - 1]; // \"1h\"\n  muteDuration = parseInt(durationStr) || 1; // —á–∞—Å—ã\n  alertType = parts.slice(1, -1).join('_');\n}\n\nreturn [{\n  json: {\n    action: action,\n    alert_type: alertType,\n    mute_duration: muteDuration,\n    chat_id: chatId,\n    message_id: messageId,\n    user_id: callback.callback_query.from.id,\n    user_name: callback.callback_query.from.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'\n  }\n}];"
      },
      "id": "parse-callback",
      "name": "–ü–∞—Ä—Å–∏–Ω–≥ Callback",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.action }}",
              "rightValue": "ack",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "check-action",
      "name": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –î–µ–π—Å—Ç–≤–∏—è",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è\nconst alertType = $json.alert_type || 'unknown';\n\nconst sqlQuery = `UPDATE telegram_alert_states\nSET \n  acknowledged_at = NOW(),\n  is_active = false,\n  updated_at = NOW()\nWHERE alert_type = '${alertType}';\n\nSELECT alert_type, acknowledged_at FROM telegram_alert_states WHERE alert_type = '${alertType}';`;\n\nreturn [{ json: { ...($json), sql_query: sqlQuery } }];"
      },
      "id": "prepare-ack-sql",
      "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sql_query }}",
        "options": {}
      },
      "id": "acknowledge-alert",
      "name": "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1120, 200],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ SQL –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è\nconst alertType = $json.alert_type || 'unknown';\nconst muteDuration = $json.mute_duration || 1;\n\nconst sqlQuery = `UPDATE telegram_alert_states\nSET \n  mute_until = NOW() + INTERVAL '${muteDuration} hours',\n  is_active = false,\n  updated_at = NOW()\nWHERE alert_type = '${alertType}';\n\nSELECT alert_type, mute_until FROM telegram_alert_states WHERE alert_type = '${alertType}';`;\n\nreturn [{ json: { ...($json), sql_query: sqlQuery } }];"
      },
      "id": "prepare-mute-sql",
      "name": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û—Ç–∫–ª—é—á–µ–Ω–∏—è",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.sql_query }}",
        "options": {}
      },
      "id": "mute-alert",
      "name": "–û—Ç–∫–ª—é—á–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [1120, 400],
      "credentials": {
        "postgres": {
          "id": "greenhouse_db",
          "name": "Greenhouse PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst callback = $node[\"–ü–∞—Ä—Å–∏–Ω–≥ Callback\"].json;\n\nlet message;\n\nif (callback.action === 'ack') {\n  message = `‚úÖ *–û–ø–æ–≤–µ—â–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ*\\n\\n–¢–∏–ø: ${callback.alert_type}\\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${callback.user_name}\\n–í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}`;\n} else {\n  const muteUntil = new Date(data.mute_until).toLocaleString('ru-RU');\n  message = `üîï *–û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ*\\n\\n–¢–∏–ø: ${callback.alert_type}\\n–û—Ç–∫–ª—é—á–µ–Ω–æ –Ω–∞: ${callback.mute_duration} —á.\\n–î–æ: ${muteUntil}\\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${callback.user_name}`;\n}\n\nreturn [{\n  json: {\n    chat_id: callback.chat_id,\n    message_id: callback.message_id,\n    message: message\n  }\n}];"
      },
      "id": "format-response",
      "name": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –û—Ç–≤–µ—Ç",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "resource": "callback",
        "operation": "answerQuery",
        "queryId": "={{ $node[\"Telegram Trigger\"].json.callback_query.id }}",
        "additionalFields": {
          "text": "–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ‚úì"
        }
      },
      "id": "answer-callback",
      "name": "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ Callback",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1560, 300],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "messageType": "editMessageText",
        "messageId": "={{ $json.message_id }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parseMode": "Markdown"
        }
      },
      "id": "edit-message",
      "name": "–ò–∑–º–µ–Ω–∏—Ç—å –°–æ–æ–±—â–µ–Ω–∏–µ",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1780, 300],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "UgAgro Telegram Bot"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "–ü–∞—Ä—Å–∏–Ω–≥ Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–∞—Ä—Å–∏–Ω–≥ Callback": {
      "main": [
        [
          {
            "node": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –î–µ–π—Å—Ç–≤–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü—Ä–æ–≤–µ—Ä–∫–∞ –î–µ–π—Å—Ç–≤–∏—è": {
      "main": [
        [
          {
            "node": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û—Ç–∫–ª—é—á–µ–Ω–∏—è",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å SQL –û—Ç–∫–ª—é—á–µ–Ω–∏—è": {
      "main": [
        [
          {
            "node": "–û—Ç–∫–ª—é—á–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –û—Ç–≤–µ—Ç",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—Ç–∫–ª—é—á–∏—Ç—å –û–ø–æ–≤–µ—â–µ–Ω–∏–µ": {
      "main": [
        [
          {
            "node": "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –û—Ç–≤–µ—Ç",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –û—Ç–≤–µ—Ç": {
      "main": [
        [
          {
            "node": "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "–û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ Callback": {
      "main": [
        [
          {
            "node": "–ò–∑–º–µ–Ω–∏—Ç—å –°–æ–æ–±—â–µ–Ω–∏–µ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-01-18T00:00:00.000Z",
  "versionId": "1"
}
