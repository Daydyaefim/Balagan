# UgAgro_95 - Рефакторированная версия

## Обзор

Это рефакторированная версия прошивки для системы управления умной теплицей на базе ESP32. Исходный монолитный код (4164 строк) был разделен на модульную архитектуру для улучшения читаемости, поддерживаемости и тестируемости.

## Архитектура

### Модули

Проект разделен на следующие модули:

#### 1. **Config.h**
- Конфигурационный файл со всеми константами
- Определения пинов (Modbus, реле)
- Сетевые настройки (WiFi, MQTT, NTP)
- Структуры данных (Settings, SensorData, HistoryEntry и др.)

#### 2. **Sensors (Sensors.h/cpp)**
- Класс `SensorManager` для работы с датчиками
- Чтение данных по Modbus от всех датчиков:
  - Датчики температуры и влажности (2 шт)
  - Датчик ветра
  - Пиранометр (солнечная радиация)
  - Датчик субстрата (мат-сенсор)
  - Датчик уровня раствора
  - Наружный датчик
- FreeRTOS задача `modbusTask` для циклического опроса

#### 3. **Actuators (Actuators.h/cpp)**
- Класс `ActuatorManager` для управления исполнительными устройствами
- Управление реле:
  - Окна (открытие/закрытие)
  - Отопление
  - Вентилятор
  - Туманообразование (клапан и насос)
  - Полив (насос, наполнение, 3-ходовой клапан)
  - Нагрев раствора
- Калибровка позиции окна

#### 4. **MqttManager (MqttManager.h/cpp)**
- Класс `MqttManager` для работы с MQTT брокером
- Публикация данных датчиков
- Публикация настроек и истории
- Обработка входящих команд
- Автоматическое переподключение

#### 5. **Storage (Storage.h/cpp)**
- Класс `StorageManager` для работы с файловой системой
- Сохранение и загрузка настроек (LittleFS, JSON)
- Сохранение и загрузка истории
- Применение настроек по умолчанию
- Cooldown механизм для предотвращения частых записей

#### 6. **ControlLogic (ControlLogic.h/cpp)**
- Класс `GreenhouseController` - основная логика управления
- Методы управления подсистемами:
  - `updateHeating()` - управление отоплением
  - `updateFan()` - управление вентилятором
  - `updateSolutionHeating()` - нагрев раствора
  - `updateFogging()` - туманообразование
  - `updateWatering()` - система полива
  - `updateWindRestriction()` - ограничение по ветру
  - `updateWindowControl()` - управление окнами
- FreeRTOS задача `logicTask`

#### 7. **commands/ (Command Pattern)**
- Паттерн Command для централизованной обработки настроек
- `ICommand.h` - базовый интерфейс для всех команд
- `CommandDispatcher.h` - диспетчер команд
- `SettingCommands.h` - шаблонные классы (FloatRangeCommand, BoolCommand, и др.)
- `AllCommands.h` - регистрация 100+ команд для всех полей Settings

#### 8. **UgAgro_95_refactored.ino**
- Главный файл прошивки
- Инициализация всех модулей
- Настройка глобального CommandDispatcher
- Настройка веб-сервера
- Создание FreeRTOS задач

## Структура файлов

```
UgAgro_95_refactored/
├── UgAgro_95_refactored.ino    # Главный файл
├── Config.h                     # Конфигурация
├── Sensors.h / Sensors.cpp      # Модуль датчиков
├── Actuators.h / Actuators.cpp  # Модуль исполнительных устройств
├── MqttManager.h / MqttManager.cpp # Модуль MQTT
├── Storage.h / Storage.cpp      # Модуль хранения данных
├── ControlLogic.h / ControlLogic.cpp # Модуль логики управления
├── commands/                    # Command Pattern (NEW!)
│   ├── ICommand.h              # Базовый интерфейс команд
│   ├── CommandDispatcher.h     # Диспетчер команд
│   ├── SettingCommands.h       # Шаблонные классы команд
│   └── AllCommands.h           # Регистрация 100+ команд
├── data/
│   └── index.html              # Веб-интерфейс
├── README.md                   # Этот файл
└── PROGRESS.md                 # Прогресс рефакторинга
```

## Преимущества рефакторинга

### 1. **Модульность**
- Каждый модуль отвечает за свою область ответственности
- Легко тестировать отдельные компоненты
- Простая замена или обновление модулей

### 2. **Читаемость**
- Код разделен на логические блоки
- Понятные имена классов и методов
- Уменьшение размера отдельных файлов

### 3. **Поддерживаемость**
- Легче находить и исправлять ошибки
- Изменения в одном модуле не влияют на другие
- Проще добавлять новые функции

### 4. **Переиспользуемость**
- Модули можно использовать в других проектах
- Стандартизованные интерфейсы

## Использование

### Компиляция

1. Откройте `UgAgro_95_refactored.ino` в Arduino IDE
2. Установите необходимые библиотеки:
   - AsyncTCP
   - ESPAsyncWebServer
   - ArduinoJson
   - PubSubClient
   - ModbusMaster
   - RTClib
   - NTPClient
3. Выберите плату ESP32
4. Скомпилируйте и загрузите

### Настройка

Отредактируйте параметры в `Config.h`:
- WiFi SSID и пароль
- MQTT брокер
- Пины устройств (если нужно)

## Примечания

### Текущий статус (v2.2-alpha)

**Этапы 1-3 завершены (60% прогресса):**

- ✅ **Этап 1**: Анализ и планирование
- ✅ **Этап 2**: Модульная архитектура (7 модулей)
- ✅ **Этап 3**: Command Pattern для устранения дублирования кода

**Что работает:**
- ✅ Модульная архитектура с четким разделением ответственности
- ✅ Command Pattern для централизованной обработки настроек
- ✅ Полная сериализация/десериализация всех 100+ полей Settings
- ✅ MQTT обработка команд (handleEquipment, handleWindow, handleHydro)
- ✅ Web API endpoints (GET/POST /settings, GET /sensors, POST /window, POST /equipment)
- ✅ Устранено дублирование кода для 100+ полей настроек

**Что требует доработки:**
- ⚠️ **ControlLogic**: Упрощенная логика управления. Требуется перенести полную логику (~900 строк) из оригинального файла

### Следующие шаги

1. ✅ ~~Применить Command Pattern для устранения дублирования~~
2. **Перенести полную логику управления** (~900 строк) в ControlLogic
   - Логика отопления с гистерезисом
   - Логика туманообразования (3 режима)
   - Логика полива (5 режимов: morning, manual, auto, mat, rad)
   - Логика управления окнами
3. **Провести тестирование** компиляции и на реальном оборудовании
4. **Добавить unit-тесты** для модулей (опционально)

## Отладка

Для включения отладочного вывода установите `DEBUG 1` в `Config.h`.

## Лицензия

Этот проект является рефакторингом существующего кода для системы управления теплицей.
