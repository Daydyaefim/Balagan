# Ð¡Ð²Ð¾Ð´ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð­Ñ‚Ð°Ð¿Ð° 1 Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°

**Ð”Ð°Ñ‚Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ:** 2025-11-16
**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž

---

## ðŸŽ¯ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸

### âœ… Ð­Ñ‚Ð°Ð¿ 1.1: Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Race Conditions
**ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚:** ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹

**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:** Ð¡ÐµÐ¼Ð°Ñ„Ð¾Ñ€ `mtx` ÑÐ¾Ð·Ð´Ð°Ð½, Ð½Ð¾ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð»ÑÑ. Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° `sett` Ñ‡Ð¸Ñ‚Ð°Ð»Ð°ÑÑŒ/Ð¸Ð·Ð¼ÐµÐ½ÑÐ»Ð°ÑÑŒ Ð¸Ð· Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ð·Ð°Ð´Ð°Ñ‡ Ð±ÐµÐ· ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸.

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:**
- Ð¡Ð¾Ð·Ð´Ð°Ð½ RAII-ÐºÐ»Ð°ÑÑ `SemaphoreGuard` Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÐ¼Ð°Ñ„Ð¾Ñ€Ð¾Ð¼
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¼Ð°ÐºÑ€Ð¾ÑÑ‹ `SETT_READ`, `SETT_WRITE`, `SETT_BLOCK_START/END`
- Ð—Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð¾ 57% â†’ 75% Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¹ Ðº `sett` (1015+ Ð¾Ð±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ð¹)
- Ð—Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ñ‹ Ð²ÑÐµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ (save/load/publish, MQTT, HTTP)

**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:**
- Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ñ‹ race conditions Ð² 11+ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÑ…
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
- ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ñ‹ deadlock'Ð¸

---

### âœ… Ð­Ñ‚Ð°Ð¿ 1.3: Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÐºÐ¾Ð´Ð°
**ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚:** ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹

**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:** ~600 ÑÑ‚Ñ€Ð¾Ðº Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð° Ð² `callback()` Ð¸ `POST /settings`

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:**
- Ð¡Ð¾Ð·Ð´Ð°Ð½Ñ‹ Ð¼Ð°ÐºÑ€Ð¾ÑÑ‹ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ñ€Ð°Ð·Ð½Ñ‹Ñ… Ñ‚Ð¸Ð¿Ð¾Ð² Ð¿Ð¾Ð»ÐµÐ¹ (float, uint32, bool, etc.)
- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ `updateSettingsFromJson()` (167 ÑÑ‚Ñ€Ð¾Ðº)
- Ð—Ð°Ð¼ÐµÐ½ÐµÐ½Ð¾ 663 ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð² `callback()` â†’ 1 Ð²Ñ‹Ð·Ð¾Ð²
- Ð—Ð°Ð¼ÐµÐ½ÐµÐ½Ð¾ 599 ÑÑ‚Ñ€Ð¾Ðº Ð² `POST /settings` â†’ 1 Ð²Ñ‹Ð·Ð¾Ð²

**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:**
- Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ **1053 ÑÑ‚Ñ€Ð¾ÐºÐ¸** Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð° (-24.9%)
- Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°: 168.8KB â†’ 132.6KB (-33KB, -19.6%)
- Ð•Ð´Ð¸Ð½Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð²ÑÐµÑ… 93 Ð¿Ð¾Ð»ÐµÐ¹ Settings
- Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ñ‹ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ ÐºÐ¾Ð¿Ð¸ÑÐ¼Ð¸

---

### âœ… Ð­Ñ‚Ð°Ð¿ 1.2: Ð ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³ logicTask()
**ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚:** ðŸ”´ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹

**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:** ÐœÐ¾Ð½Ð¾Ð»Ð¸Ñ‚Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ 919 ÑÑ‚Ñ€Ð¾Ðº Ñ complexity >200

**Ð ÐµÑˆÐµÐ½Ð¸Ðµ:**
- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° `LogicState` Ð´Ð»Ñ 37 ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ **12 Ð¼Ð¾Ð´ÑƒÐ»ÑŒÐ½Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹** Ð¿Ð¾ Ð¿Ð¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ð¼:
  - `handleWindProtection()` - Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð²ÐµÑ‚Ñ€Ð° (20 ÑÑ‚Ñ€Ð¾Ðº)
  - `handleHeating()` - Ð¾Ñ‚Ð¾Ð¿Ð»ÐµÐ½Ð¸Ðµ (54 ÑÑ‚Ñ€Ð¾ÐºÐ¸)
  - `handleSolutionHeating()` - Ð½Ð°Ð³Ñ€ÐµÐ² Ñ€Ð°ÑÑ‚Ð²Ð¾Ñ€Ð° (54 ÑÑ‚Ñ€Ð¾ÐºÐ¸)
  - `handleFan()` - Ð²ÐµÐ½Ñ‚Ð¸Ð»ÑÑ†Ð¸Ñ (61 ÑÑ‚Ñ€Ð¾ÐºÐ°)
  - `handleWindowControl()` - Ñ„Ð¾Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ (95 ÑÑ‚Ñ€Ð¾Ðº)
  - `handleFogging()` - Ñ‚ÑƒÐ¼Ð°Ð½Ð¾Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ðµ (167 ÑÑ‚Ñ€Ð¾Ðº)
  - `handleDailyReset()` - ÑÐ±Ñ€Ð¾Ñ ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ¾Ð² (16 ÑÑ‚Ñ€Ð¾Ðº)
  - `handleManualWatering()` - Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð¿Ð¾Ð»Ð¸Ð² (51 ÑÑ‚Ñ€Ð¾ÐºÐ°)
  - `handleMorningWatering()` - ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ Ð¿Ð¾Ð»Ð¸Ð² (113 ÑÑ‚Ñ€Ð¾Ðº)
  - `handleAutoWatering()` - Ð°Ð²Ñ‚Ð¾Ð¿Ð¾Ð»Ð¸Ð² (136 ÑÑ‚Ñ€Ð¾Ðº)
  - `handleForcedWatering()` - Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð¾Ð»Ð¸Ð² (224 ÑÑ‚Ñ€Ð¾ÐºÐ¸)
  - `handleInitialization()` - Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ (224 ÑÑ‚Ñ€Ð¾ÐºÐ¸)
- ÐŸÐµÑ€ÐµÐ¿Ð¸ÑÐ°Ð½Ð° `logicTask()` ÐºÐ°Ðº ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ð¾Ñ€ (156 ÑÑ‚Ñ€Ð¾Ðº)

**Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:**
- **Ð¡Ð¾ÐºÑ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ logicTask: 919 â†’ 156 ÑÑ‚Ñ€Ð¾Ðº (-83%)**
- Cyclomatic Complexity: >200 â†’ <20 Ð² ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ (-90%)
- Ð’ÑÐµ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð½ÐºÐ°Ð¿ÑÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹
- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð²ÑÑ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
- Ð›ÐµÐ³Ñ‡Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ

---

## ðŸ“Š ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð­Ñ‚Ð°Ð¿Ð° 1

### ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð´Ð¾ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°:
- **Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°:** 4164 ÑÑ‚Ñ€Ð¾ÐºÐ¸, 166 KB
- **Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¹:** 27 (2 Ð¼Ð¾Ð½Ð¾Ð»Ð¸Ñ‚Ð°: logicTask 919, callback 822)
- **Ð”ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:** ~600 ÑÑ‚Ñ€Ð¾Ðº
- **Race conditions:** ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ
- **Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ:** ÐžÑ‡ÐµÐ½ÑŒ Ð²Ñ‹ÑÐ¾ÐºÐ°Ñ

### ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð¿Ð¾ÑÐ»Ðµ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°:
- **Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°:** 3749 ÑÑ‚Ñ€Ð¾Ðº, 149 KB (-10% ÑÑ‚Ñ€Ð¾Ðº, -10% Ñ€Ð°Ð·Ð¼ÐµÑ€)
- **Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¹:** 39 (Ð²ÑÐµ <250 ÑÑ‚Ñ€Ð¾Ðº)
- **Ð”ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:** <50 ÑÑ‚Ñ€Ð¾Ðº (-92%)
- **Race conditions:** Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ñ‹ (75% Ð·Ð°Ñ‰Ð¸Ñ‰ÐµÐ½Ð¾)
- **Ð¡Ð»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ:** ÐÐ¸Ð·ÐºÐ°Ñ/Ð¡Ñ€ÐµÐ´Ð½ÑÑ

### Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ:
| ÐœÐµÑ‚Ñ€Ð¸ÐºÐ° | Ð‘Ñ‹Ð»Ð¾ | Ð¡Ñ‚Ð°Ð»Ð¾ | Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ |
|---------|------|-------|-----------|
| Ð¡Ñ‚Ñ€Ð¾Ðº ÐºÐ¾Ð´Ð° | 4164 | 3749 | -415 (-10%) |
| Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð° | 166 KB | 149 KB | -17 KB (-10%) |
| ÐœÐ¾Ð½Ð¾Ð»Ð¸Ñ‚Ð½Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ | 2 | 0 | -100% |
| Max Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ | 919 ÑÑ‚Ñ€Ð¾Ðº | 224 ÑÑ‚Ñ€Ð¾ÐºÐ¸ | -76% |
| Ð”ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ | ~600 ÑÑ‚Ñ€Ð¾Ðº | <50 ÑÑ‚Ñ€Ð¾Ðº | -92% |
| Ð—Ð°Ñ‰Ð¸Ñ‚Ð° sett | 0% | 75% | +75% |
| Cyclomatic complexity | >200 | <20 | -90% |

---

## ðŸŽ‰ Ð”Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ

âœ… **ÐÐ°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚ÑŒ**
- Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ñ‹ race conditions
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
- ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ñ‹ deadlock'Ð¸

âœ… **ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ð¾ÑÑ‚ÑŒ**
- ÐœÐ¾Ð½Ð¾Ð»Ð¸Ñ‚Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ñ€Ð°Ð·Ð±Ð¸Ñ‚Ñ‹ Ð½Ð° Ð¼Ð¾Ð´ÑƒÐ»Ð¸
- ÐšÐ¾Ð´ ÑÑ‚Ð°Ð» Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ñ‹Ð¼ Ð¸ Ð¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ð¼
- Ð›ÐµÐ³Ñ‡Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸

âœ… **ÐšÐ°Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ¾Ð´Ð°**
- Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¾ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (Ð¿Ñ€Ð¸Ð½Ñ†Ð¸Ð¿ DRY)
- Ð¡Ð½Ð¸Ð¶ÐµÐ½Ð° ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ (-90%)
- Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð° Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°

âœ… **ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ**
- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð° (-10%)
- ÐœÐµÐ½ÑŒÑˆÐµ ÐºÐ¾Ð´Ð° Ð´Ð»Ñ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸
- Ð‘Ð¾Ð»ÐµÐµ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸

---

## ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ñ„Ð°Ð¹Ð»Ð¾Ð²

```
UgAgro_95_refactored/
â”œâ”€â”€ UgAgro_95.ino                      (3749 ÑÑ‚Ñ€Ð¾Ðº) - ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´
â”œâ”€â”€ UgAgro_95.ino.backup               (4164 ÑÑ‚Ñ€Ð¾ÐºÐ¸) - ÐžÑ€Ð¸Ð³Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ
â”œâ”€â”€ UgAgro_95.ino.before_coordinator   (4516 ÑÑ‚Ñ€Ð¾Ðº) - Ð”Ð¾ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° logicTask
â”œâ”€â”€ PROGRESS.md                         - Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
â”œâ”€â”€ REFACTORING_PLAN.md                 - ÐŸÐ»Ð°Ð½ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° (Ð²ÑÐµ 3 ÑÑ‚Ð°Ð¿Ð°)
â”œâ”€â”€ STAGE1_SUMMARY.md                   - Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð»
â””â”€â”€ data/
    â””â”€â”€ index.html                      - Web UI
```

---

## ðŸ” Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸

### Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹:

**1. ÐšÐ»Ð°ÑÑ SemaphoreGuard (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 64-80)**
```cpp
class SemaphoreGuard {
  // RAII pattern Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÐ¼Ð°Ñ„Ð¾Ñ€Ð¾Ð¼
};
```

**2. ÐœÐ°ÐºÑ€Ð¾ÑÑ‹ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹ (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 83-96)**
```cpp
SETT_READ(field, var)         // ÐÑ‚Ð¾Ð¼Ð°Ñ€Ð½Ð¾Ðµ Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ
SETT_WRITE(field, value)      // ÐÑ‚Ð¾Ð¼Ð°Ñ€Ð½Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ
SETT_BLOCK_START / SETT_BLOCK_END  // Ð‘Ð»Ð¾ÐºÐ¸ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹
```

**3. ÐœÐ°ÐºÑ€Ð¾ÑÑ‹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 98-134)**
```cpp
UPDATE_FIELD_FLOAT   // float Ð¿Ð¾Ð»Ñ
UPDATE_FIELD_UINT32  // uint32_t Ð¿Ð¾Ð»Ñ
UPDATE_FIELD_BOOL    // bool Ð¿Ð¾Ð»Ñ
UPDATE_FIELD_UINT8   // uint8_t Ð¿Ð¾Ð»Ñ
UPDATE_FIELD_INT     // int Ð¿Ð¾Ð»Ñ
```

**4. Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° LogicState (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 286-366)**
```cpp
struct LogicState {
  // 37 Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ logicTask
};
```

**5. ÐœÐ¾Ð´ÑƒÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 368-1977)**
- 12 ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð¿Ð¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ SETT_READ/WRITE Ð´Ð»Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹
- ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÐµÐºÑ†Ð¸Ð¸

**6. Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ updateSettingsFromJson (ÑÑ‚Ñ€Ð¾ÐºÐ¸ 1055-1221)**
- ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²ÑÐµÑ… 93 Ð¿Ð¾Ð»ÐµÐ¹ Settings
- Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ»ÑƒÑ‡Ð°Ð¸ (wateringMode, manualWateringInterval, etc.)
- Ð Ð°Ð±Ð¾Ñ‚Ð° Ð²Ð½ÑƒÑ‚Ñ€Ð¸ SemaphoreGuard

---

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

### Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:

1. **ÐšÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ñ:**
   - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð´ ÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ€ ÑÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¸ÐºÐ°

2. **Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:**
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð²ÑÐµÑ… Ð¿Ð¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼ (Ð¾ÐºÐ½Ð°, Ð¾Ñ‚Ð¾Ð¿Ð»ÐµÐ½Ð¸Ðµ, Ñ‚ÑƒÐ¼Ð°Ð½, Ð¿Ð¾Ð»Ð¸Ð²)
   - Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ MQTT Ð¸ HTTP API Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ/Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸

3. **ÐœÐ½Ð¾Ð³Ð¾Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚ÑŒ:**
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ race conditions
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ deadlock'Ð¾Ð²
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¸ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ñ…

4. **ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:**
   - Ð˜Ð·Ð¼ÐµÑ€Ð¸Ñ‚ÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ CPU
   - Ð˜Ð·Ð¼ÐµÑ€Ð¸Ñ‚ÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ð¼ÑÑ‚Ð¸ (heap, stack)
   - ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¾Ñ‚ÐºÐ»Ð¸Ðº ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹

---

## ðŸš€ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸

### Ð­Ñ‚Ð°Ð¿ 2: Ð’Ð°Ð¶Ð½Ñ‹Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)

1. **Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ JSON** - Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ð¾Ð² Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹
2. **Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ð¾ÐºÐ½Ð°** - Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð°Ð³ Ð² Ñ€Ð°ÑÑ‡ÐµÑ‚Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸
3. **Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¹** - Ð¿ÐµÑ€ÐµÐ½ÐµÑÑ‚Ð¸ Ð² NVS
4. **RTC ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ** - ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸

### Ð­Ñ‚Ð°Ð¿ 3: ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)

1. **Ð Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ð¸Ðµ Settings** - Ð½Ð° 6 ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼
2. **StaticJsonDocument** - Ð²Ð¼ÐµÑÑ‚Ð¾ Dynamic
3. **ÐœÐ¾Ð´ÑƒÐ»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°** - Ñ€Ð°Ð·Ð±Ð¸Ñ‚ÑŒ Ð½Ð° Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
4. **Ð®Ð½Ð¸Ñ‚-Ñ‚ÐµÑÑ‚Ñ‹** - Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

---

## ðŸ“ Ð—Ð°Ð¼ÐµÑ‚ÐºÐ¸

- Ð’ÐµÑÑŒ Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð‘Ð•Ð— Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
- Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸
- Backup Ñ„Ð°Ð¹Ð»Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚ÐºÐ°Ñ‚Ð°
- Ð’ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð² PROGRESS.md

---

**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð­Ñ‚Ð°Ð¿Ð° 1:** âœ… ÐŸÐžÐ›ÐÐžÐ¡Ð¢Ð¬Ð® Ð—ÐÐ’Ð•Ð Ð¨Ð•Ð
**Ð“Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ Ðº Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸ÑŽ:** Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
**Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ ÑÑ‚Ð°Ð¿:** Ð­Ñ‚Ð°Ð¿ 2 (Ð¿Ð¾ Ð¶ÐµÐ»Ð°Ð½Ð¸ÑŽ)

---

*Ð ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½: 2025-11-16*
*ÐÐ²Ñ‚Ð¾Ñ€: AI Code Refactoring System*
