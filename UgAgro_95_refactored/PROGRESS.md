# –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ UgAgro_95

**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** 2025-11-16
**–°—Ç–∞—Ç—É—Å:** –í –ø—Ä–æ—Ü–µ—Å—Å–µ

---

## üéØ –≠—Ç–∞–ø 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### 1.1 –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ Race Conditions ‚ö†Ô∏è –ü–†–ò–û–†–ò–¢–ï–¢ #1

- [ ] –°–æ–∑–¥–∞—Ç—å RAII-–æ–±–µ—Ä—Ç–∫—É –¥–ª—è —Å–µ–º–∞—Ñ–æ—Ä–∞ (SemaphoreGuard)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –≤ logicTask() (~50 –º–µ—Å—Ç)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –≤ callback() (~93 –ø–æ–ª—è)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∑–∞—â–∏—Ç—É –≤ HTTP handlers POST /settings
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

**–°—Ç–∞—Ç—É—Å:** –ù–µ –Ω–∞—á–∞—Ç–æ
**–û—Ü–µ–Ω–∫–∞:** 3-4 –¥–Ω—è

---

### 1.2 –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–∏ logicTask() ‚ö†Ô∏è –ü–†–ò–û–†–ò–¢–ï–¢ #2

- [ ] –°–æ–∑–¥–∞—Ç—å struct LogicState –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- [ ] –í—ã–¥–µ–ª–∏—Ç—å handleWindowControl()
- [ ] –í—ã–¥–µ–ª–∏—Ç—å handleHeating()
- [ ] –í—ã–¥–µ–ª–∏—Ç—å handleFan()
- [ ] –í—ã–¥–µ–ª–∏—Ç—å handleFogging()
- [ ] –í—ã–¥–µ–ª–∏—Ç—å handleWatering() (–±–æ–ª—å—à–∞—è –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞)
- [ ] –í—ã–¥–µ–ª–∏—Ç—å handleSolutionHeating()
- [ ] –í—ã–¥–µ–ª–∏—Ç—å handleFillTank()
- [ ] –í—ã–¥–µ–ª–∏—Ç—å handleWindProtection()
- [ ] –û–±–Ω–æ–≤–∏—Ç—å main logicTask() –¥–ª—è –≤—ã–∑–æ–≤–∞ –º–æ–¥—É–ª–µ–π
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏

**–°—Ç–∞—Ç—É—Å:** –ù–µ –Ω–∞—á–∞—Ç–æ
**–û—Ü–µ–Ω–∫–∞:** 5-7 –¥–Ω–µ–π

---

### 1.3 –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ ‚ö†Ô∏è –ü–†–ò–û–†–ò–¢–ï–¢ #3

- [x] –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é updateSettingsFromJson()
- [x] –°–æ–∑–¥–∞—Ç—å –º–∞–∫—Ä–æ—Å—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π
- [x] –ó–∞–º–µ–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ callback() (~663 —Å—Ç—Ä–æ–∫–∏ ‚Üí 1 –≤—ã–∑–æ–≤)
- [x] –ó–∞–º–µ–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ POST /settings (~599 —Å—Ç—Ä–æ–∫ ‚Üí 1 –≤—ã–∑–æ–≤)
- [ ] –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –æ–ø–∏—Å–∞–Ω–∏–π –≤—Å–µ—Ö –ø–æ–ª–µ–π Settings
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞

**–°—Ç–∞—Ç—É—Å:** –í –ø—Ä–æ—Ü–µ—Å—Å–µ (–±–∞–∑–æ–≤—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω)
**–û—Ü–µ–Ω–∫–∞:** 3-4 –¥–Ω—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ –£–¥–∞–ª–µ–Ω–æ **1053 —Å—Ç—Ä–æ–∫–∏** –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞: **33KB** (19.6%)
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –º–∞–∫—Ä–æ—Å–∞–º–∏ –¥–ª—è –≤—Å–µ—Ö 93 –ø–æ–ª–µ–π
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ (wateringMode, manualWateringInterval, etc.)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å SemaphoreGuard –∑–∞—â–∏—Ç–æ–π

---

## üìä –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≠—Ç–∞–ø–∞ 1

**–í—Å–µ–≥–æ –∑–∞–¥–∞—á:** 27
**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** 4
**–í –ø—Ä–æ—Ü–µ—Å—Å–µ:** 3
**–û—Å—Ç–∞–ª–æ—Å—å:** 20

**–ü—Ä–æ–≥—Ä–µ—Å—Å:** 14.8% (4/27 –∑–∞–¥–∞—á –∑–∞–≤–µ—Ä—à–µ–Ω–æ)

---

## üìù –ñ—É—Ä–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 2025-11-16

#### –≠—Ç–∞–ø 1.3: –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ ‚úÖ
**–í—Ä–µ–º—è:** ~2 —á–∞—Å–∞

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:**
1. –°–æ–∑–¥–∞–Ω—ã –º–∞–∫—Ä–æ—Å—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π Settings:
   - `UPDATE_FIELD_FLOAT` - –¥–ª—è float –ø–æ–ª–µ–π
   - `UPDATE_FIELD_UINT32` - –¥–ª—è uint32_t –ø–æ–ª–µ–π
   - `UPDATE_FIELD_UINT64_AS_UINT32` - –¥–ª—è –ø–æ–ª–µ–π —Å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º uint64‚Üíuint32
   - `UPDATE_FIELD_BOOL` - –¥–ª—è bool –ø–æ–ª–µ–π
   - `UPDATE_FIELD_UINT8` - –¥–ª—è uint8_t –ø–æ–ª–µ–π
   - `UPDATE_FIELD_INT` - –¥–ª—è int –ø–æ–ª–µ–π

2. –°–æ–∑–¥–∞–Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `updateSettingsFromJson()`:
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ 93 –ø–æ–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Settings
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏ (wateringMode, manualWateringInterval, etc.)
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤ wateringModes
   - –†–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ SemaphoreGuard –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

3. –ó–∞–º–µ–Ω–µ–Ω –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ callback() (MQTT –æ–±—Ä–∞–±–æ—Ç—á–∏–∫):
   - –ë—ã–ª–æ: ~663 —Å—Ç—Ä–æ–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞
   - –°—Ç–∞–ª–æ: 1 –≤—ã–∑–æ–≤ `updateSettingsFromJson(doc)`
   - –õ–æ–∫–∞—Ü–∏—è: —Å—Ç—Ä–æ–∫–∏ 1247-1909 ‚Üí 1 —Å—Ç—Ä–æ–∫–∞

4. –ó–∞–º–µ–Ω–µ–Ω –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ POST /settings (HTTP –æ–±—Ä–∞–±–æ—Ç—á–∏–∫):
   - –ë—ã–ª–æ: ~599 —Å—Ç—Ä–æ–∫ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞
   - –°—Ç–∞–ª–æ: 1 –≤—ã–∑–æ–≤ `updateSettingsFromJson(doc)`
   - –õ–æ–∫–∞—Ü–∏—è: —Å—Ç—Ä–æ–∫–∏ 2865-3463 ‚Üí 1 —Å—Ç—Ä–æ–∫–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- –£–¥–∞–ª–µ–Ω–æ: **1053 —Å—Ç—Ä–æ–∫–∏** –∫–æ–¥–∞ (24.9%)
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 168.8KB ‚Üí 132.6KB (-33KB, -19.6%)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫: 4235 ‚Üí 3182
- –£–ª—É—á—à–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å: —Ç–µ–ø–µ—Ä—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –¥–µ–ª–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –¥–≤—É–º—è –∫–æ–ø–∏—è–º–∏ –∫–æ–¥–∞

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç (—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—à–µ–ª –≥–ª–∞–¥–∫–æ)

---

#### –ù–∞—á–∞–ª–æ –ø—Ä–æ–µ–∫—Ç–∞
- –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ UgAgro_95_refactored
- –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥
- –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
- –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

---

## üêõ –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

_–ó–¥–µ—Å—å –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –ø—Ä–æ–±–ª–µ–º—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞_

---

## ‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

_–ó–¥–µ—Å—å –±—É–¥—É—Ç –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è —Ä–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã_
